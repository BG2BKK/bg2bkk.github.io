
<!DOCTYPE html>
<html lang="">

    <head>

        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <meta property="og:title" content=" coroutine and goroutine &middot;  BG2BKK Site" />
        <meta property="og:site_name" content="BG2BKK Site" />
        <meta property="og:url" content="https://bg2bkk.github.io/post/coroutine%20and%20goroutine/" />

    
        <meta property="og:type" content="article" />
        <meta property="og:article:published_time" content="2016-03-13T17:59:29&#43;08:00" />
        

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@" />
        <meta name="twitter:creator" content="@" />
        <meta name="twitter:title" content="coroutine and goroutine" />
        <meta name="twitter:description" content="" />
        <meta name="twitter:url" content="https://bg2bkk.github.io/post/coroutine%20and%20goroutine/" />
    

        <title> coroutine and goroutine &middot;  BG2BKK Site</title>

    
        <meta name="description" content="" />
    
        
        <meta name="p:domain_verify" content="fc173d84e3a4de948ed4bda2908afd3e"/>
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        
          

    
        <link href="https://bg2bkk.github.io/index.xml" rel="alternate" type="application/rss+xml" title="BG2BKK Site" />
    

    
        <link rel="canonical" href="https://bg2bkk.github.io/post/coroutine%20and%20goroutine/" />

    
    <script type="application/ld+json">
    { 
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "coroutine and goroutine",
        "author": {
            "@type": "Person",
            "name": "http://profiles.google.com/?rel=author"
        },
        "datePublished": "2016-03-13",
        "description": "",
        "wordCount":  1870 
    }
    </script>
    
    
    <style>
*{padding:0;margin:0}body,html{font-size:1em;line-height:1.65em;font-family:"Open Sans",sans-serif;font-weight:300;color:#444}html{height:100%}body{padding:2em 2.5em 1em 20em}header{border-right:1px #eee solid;padding:2em;position:fixed;top:0;left:0;height:100%;width:13.5em}#content{display:block;width:100%}footer{padding:1em 0 2.5em;font-size:.8em;line-height:1.5em;color:#888}article{border-bottom:.1em #eee solid;padding-bottom:1.7em;max-width:56em}h4,h5,h6,hr,p{margin-top:.9em;margin-bottom:.9em}h1,h2,h3,h4,h5,h6{font-family:"Microsoft Yahei",serif;font-weight:400!important}h1{font-size:2.5em;line-height:1.1em;margin-top:.6em;margin-bottom:.6em}h2{font-size:1.9em;line-height:1.2em;margin-top:.7em;margin-bottom:.7em}h3{font-size:1.4em;line-height:1.3em;margin-top:.8em;margin-bottom:.8em}h4{font-size:1.3em}h5{font-size:1.2em}h6{font-size:1.1em}iframe,img{max-width:100%}a{font-weight:700;text-decoration:none;color:#5cc265}a:hover{text-decoration:underline}h1 a,h2 a,h3 a,h4 a,h5 a,h6 a{font-weight:400!important}strong{font-weight:700}blockquote{border-left:.4em solid #eee;padding-left:1.2em;font-size:1.3em}hr{border:0;height:1px;background:#eee}ol,ul{margin-left:3em}code{font-size:1.4em;background:#eee}pre{font-size:.8em;line-height:2em;background:#eee;padding:1em;word-break:break-all;word-wrap:break-word;white-space:pre;white-space:-moz-pre-wrap;white-space:pre-wrap}input{font-size:1em;padding:.3em}header h1{font-size:1.9em;margin-top:.8em;margin-bottom:.6em}header h1 a{color:#444}header h1 a:hover{text-decoration:none}header #logo img{width:9em;height:9em;border-radius:4.5em;-moz-border-radius:4.5em;-webkit-border-radius:4.5em;border:none}#follow-icons{font-size:.7em;margin-top:-.7em;margin-bottom:1.5em}#follow-icons a{color:#ccc}#follow-icons span{vertical-align:top;margin-left:-.15em;margin-right:-.15em}#follow-icons span .fa-stack-1x{font-size:1.05em;line-height:1.9em}header h6{margin-top:.5em}article span.post-stamp{color:#888}h1.post-title{margin-top:.35em;margin-bottom:.6em}h3.post-title{margin-top:.4em;padding-bottom:.9em;border-bottom:1px solid #eee;font-size:1.2em;color:#444}.post-title time{font-size:0.5em}.post-title a{color:#494949;font-family:"Bree Serif",serif;}.post-title .feature-star{font-size:.9em}.feature-star,.separator,.taglist{color:#ccc}.taglist a{background-color:#ccc;color:#fff;display:inline-block;line-height:1.5em;padding:.3em .6em;vertical-align:20%;font-size:.5em;font-family:"Open Sans",sans-serif;font-weight:700!important;text-transform:uppercase;letter-spacing:.05em;border-radius:.25em;-moz-border-radius:.25em;-webkit-border-radius:.25em}#social-bar{margin-top:1.5em;background-color:#eee;padding:.5em}#comments{margin-top:.15em;padding-bottom:.2em;border-bottom:1px solid #eee}.pagination{margin-bottom:1em}footer a{font-weight:300;color:#888;text-decoration:underline}footer a:hover{color:#444;text-decoration:none}@media only screen and (min-width:1281px){body,html{font-size:1.1em}}@media only screen and (max-width:800px){body{padding:0}header{border-right:none;border-bottom:1px #eee solid;position:relative;height:auto;width:auto;text-align:center;padding-bottom:1em}#content{margin-left:0;padding:2em 2em 1em;width:auto}footer{padding:0 2.5em 2em}}@media only screen and (max-width:320px){#content,header{padding:1.2em 1.2em .6em}footer{padding:0 1.5em 1.2em}ol,ul{margin-left:2em}}
</style>

    </head>
    <body>
        <header id="header">
            
            <a id="logo" href="https://bg2bkk.github.io/"><img src="https://raw.githubusercontent.com/BG2BKK/githubio/master/themes/crisp/images/eagle.jpg" alt="BG2BKK Site" /></a> 
            <h1><a href="https://bg2bkk.github.io/">BG2BKK Site</a></h1>
            <p></p>

            <div id="follow-icons">
	<a href="http://facebook.com/bg2bkk" rel="me"><i class="fa fa-facebook-square fa-2x"></i></a>
	<a href="http://twitter.com/bg2bkk1" rel="me"><i class="fa fa-twitter-square fa-2x"></i></a>
	<a href="http://github.com/bg2bkk" rel="me"><i class="fa fa-linkedin-square fa-2x"></i></a>
	<a href="http://github.com/bg2bkk" rel="me"><i class="fa fa-github-square fa-2x"></i></a>
	<a href="http://plus.google.com/bg2bkk" rel="author"><i class="fa fa-google-plus-square fa-2x"></i></a>
	<a href="https://bg2bkk.github.io/index.xml" rel="me"><i class="fa fa-rss-square fa-2x"></i></a> 
</div>  

            <h6><a href="https://bg2bkk.github.io/post/resume/">About</a></h6>

        </header>

<main id="content">

<article id="" class="post">
    <div class="post-stamp">
        <time datetime="2016-03-13T17:59:29&#43;08:00">
            13 Mar 2016
        </time>
        <span class="taglist">
        
        </span>
    </div>
    <h1 class="post-title">coroutine and goroutine</h1>
    

<h4 id="协程是什么-what-is-coroutine">协程是什么？ what is coroutine ?</h4>

<ul>
<li><a href="https://en.wikipedia.org/wiki/Coroutine">协程的概念</a></li>
</ul>

<blockquote>
<p>Coroutines are computer program components that generalize subroutines for nonpreemptive multitasking, by allowing multiple entry points for suspending and resuming execution at certain locations. Coroutines are well-suited for implementing more familiar program components such as cooperative tasks, exceptions, event loop, iterators, infinite lists and pipes.</p>

<p>According to Donald Knuth, the term coroutine was coined by Melvin Conway in 1958, after he applied it to construction of an assembly program.[1] The first published explanation of the coroutine appeared later, in 1963.[2]</p>
</blockquote>

<p>协程是为实现非抢占式多任务而提出的计算机子程序，通过提供多个程序入口使得程序可以在特定地址挂起和恢复执行。协程天生的支持实现常见程序组件，比如协作式任务、异常、时间循环、迭代器、无边界列表和管道等。</p>

<p>根据祖师爷高纳德节说，协程的概念由Melvin Conway在1958年提出，随后他将协程应用在编写汇编程序上。协程的第一个公开发表的解释出现在1963年。</p>

<p>可见协程的概念比多线程还早，而且按照Knuth的说法，<a href="http://coolshell.cn/articles/10975.html">”子例程是协程的特例“，一次子例程调用就是一次子函数调用</a>，协程是类函数一样的组件，我们可以在单线程中创建N多个协程，只要内存够用。</p>

<pre><code>* 协程与子例程的[区别](https://en.wikipedia.org/wiki/Coroutine)
    * 子例程只有一个调用入口起点，子例程退出后，执行结束；子例程只返回一次，在两次调用之间不保存状态；
    * 协程有多个入口，调用起始点、或者从上一次返回点接着执行；从协程自己的角度来看，他放弃执行时不是退出，而是去调用另一个协程，或者说将CPU主动让给另一个协程；协程保存状态;
        * 计算机科学中，[yield](https://en.wikipedia.org/wiki/Yield_(multithreading))用于使处理器放弃当前运行的线程thread，并将它放入运行队列的末尾
        * 协程coroutine中的yield需要显式调用
    * 每个子例程可以转换为一个不带yield的协程
</code></pre>

<p>协程有关的四个概念：<a href="https://en.wikipedia.org/wiki/Coroutine">coroutine</a>、[yield](<a href="https://en.wikipedia.org/wiki/Yield_(multithreading)、[Continuation](https://en.wikipedia.org/wiki/Continuation)、[cooperative">https://en.wikipedia.org/wiki/Yield_(multithreading)、[Continuation](https://en.wikipedia.org/wiki/Continuation)、[cooperative</a> multitasking](<a href="https://en.wikipedia.org/wiki/Cooperative_multitasking)。以及其他相关概念：[call">https://en.wikipedia.org/wiki/Cooperative_multitasking)。以及其他相关概念：[call</a> stack](<a href="https://en.wikipedia.org/wiki/Call_stack#Unwinding">https://en.wikipedia.org/wiki/Call_stack#Unwinding</a>)</p>

<ul>
<li><a href="http://www.chiark.greenend.org.uk/~sgtatham/coroutines.html">Coroutines in C</a>

<ul>
<li><a href="http://www.hawkwithwind.net/blog/2011/02/18/%E5%8D%8F%E7%A8%8B%E7%9A%84c%E5%AE%9E%E7%8E%B0/">给你一个直观的认识</a></li>
</ul></li>
</ul>

<pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
int function(void) {
	static int i, state = 0;
	switch (state) {
		case 0: goto LABEL0;
		case 1: goto LABEL1;
	}
LABEL0: /* start of function */
	for (i = 0; i &lt; 10; i++) {
		printf(&quot;\t\t\ti = %d\n&quot;, i);
		state = 1; /* so we will come back to LABEL1 */
		return i;
LABEL1:
		; /* resume control straight after the return */
	}
}

int main(){
	int j = 0;
	for ( j = 0; j &lt; 21; j++){
		printf(&quot;j = %d, func = %d\n&quot;, j, function());
	}
}

</code></pre>

<p>执行结果</p>

<pre><code class="language-bash">			i = 0
j = 0, func = 0
			i = 1
j = 1, func = 1
			i = 2
j = 2, func = 2
			i = 3
j = 3, func = 3
			i = 4
j = 4, func = 4
			i = 5
j = 5, func = 5
			i = 6
j = 6, func = 6
			i = 7
j = 7, func = 7
			i = 8
j = 8, func = 8
			i = 9
j = 9, func = 9
j = 10, func = 10
j = 11, func = 11
j = 12, func = 12
j = 13, func = 13
j = 14, func = 14
j = 15, func = 15
j = 16, func = 16
j = 17, func = 17
j = 18, func = 18
j = 19, func = 19
j = 20, func = 20
</code></pre>

<ul>
<li><p>执行结果分析</p>

<ul>
<li>变量i 和 state 都是 static类型的，是文件全局作用域的</li>
<li>首次执行function函数时，state = 0，goto 到 LABEL0，然后进行正常循环和返回</li>
<li>当function调用次数超过十次后，每次进入function函数内部时，由switch分发到LABEL1；执行完循环体后，对i增1，然后进行判断是否 i &lt; 10，发现不满足，退出程序</li>
<li>可能我们会比较纠结function程序在 i &gt; 10后不再执行return i语句，为什么还会返回自增后的结果呢？

<ul>
<li>从代码的汇编结果来看，每次function返回时，i都在之前赋值给寄存器eax了，而eax存储的是函数的返回值，所以每次function的返回结果是i，即使不执行return语句</li>
</ul></li>
<li>return在这里并不是返回的意思，而是yield的意思</li>
</ul></li>

<li><p>仍然有两种更优化的写法: <a href="http://coolshell.cn/articles/10975.html">左耳朵耗子的例子</a>和<a href="http://www.hawkwithwind.net/blog/2011/02/18/%E5%8D%8F%E7%A8%8B%E7%9A%84c%E5%AE%9E%E7%8E%B0/">上例</a>的来源都是天才程序员  <a href="http://www.chiark.greenend.org.uk/~sgtatham/">imon Tatham</a>对<a href="http://www.chiark.greenend.org.uk/~sgtatham/coroutines.html">协程做的尝试</a>，以及关于swtich-case写法的duff机器的<a href="http://bbs.chinaunix.net/thread-1833313-1-1.html">讨论</a></p></li>

<li><p>理解<a href="http://www.colaghost.net/os/unix_linux/341">协程实现的基础</a>就是程序中的函数调用导致的<a href="http://blog.csdn.net/ylyuanlu/article/details/18947951">栈帧切换</a>，在切换前先保存被切换subroutine的上下文，在切换时用新subroutine替换当前程序的执行状态。以Linux中用于实现协程的一个api：ucontext来说，makecontext函数将context的eip设置为func参数的地址，所以当该context得以执行时，func函数就开始执行了；swapcontext(old, new)将当前程序处于的old状态切换到new状态，然后new状态的func就得以执行。</p></li>

<li><p>Linux对于协程实现提供了setjmp/longjmp和ucontext两种机制，现有的协程库，比如<a href="http://dunkels.com/adam/pt/">protothread</a>，甚至是LuaVM中的协程实现，也会基于这两种机制之一来实现。当然，您也可以手动切换cpu的所有寄存器状态，以实现协程，也是可以的，但是是极不推荐的。</p></li>
</ul>

<h2 id="setjump-longjmp">setjump &amp; longjmp</h2>

<h5 id="man-longjmp">man longjmp</h5>

<pre><code class="language-bash">NAME
       longjmp, siglongjmp - nonlocal jump to a saved stack context

SYNOPSIS
       #include &lt;setjmp.h&gt;

       void longjmp(jmp_buf env, int val);
       void siglongjmp(sigjmp_buf env, int val);

DESCRIPTION
       longjmp()  and  setjmp(3) are useful for dealing with errors and interrupts encountered in a low-level subroutine of a program. 
	   
       longjmp和setjmp在处理程序调用子例程过程中遇到错误或中断时非常有用。
	   
       longjmp() restores the environment saved by the last call of setjmp(3) with the corresponding env argument.  After longjmp() is completed, program execution continues as if the corresponding call of setjmp(3) had just returned the value val.  longjmp() cannot cause 0 to be returned.  If longjmp() is invoked with a second argument of 0, 1 will be returned instead.

       longjmp将恢复最近一次调用setjmp时通过env参数保存的上下文环境。longjmp完成后，原来调用setjmp的地方将会返回，并且setjmp的返回值是longjmp的val参数。longjmp不会返回0。如果longjmp调用时第二个参数是0，那么它将会返回1.

       siglongjmp()  is  similar  to longjmp() except for the type of its env argument.  If, and only if, the sigsetjmp(3) call that set this env used a nonzero savesigs flag, siglongjmp() also restores the signal mask that was saved by sigsetjmp(3).

RETURN VALUE
       These functions never return.

</code></pre>

<h5 id="man-setjmp">man setjmp</h5>

<pre><code class="language-bash">NAME
       setjmp, sigsetjmp - save stack context for nonlocal goto

SYNOPSIS
       #include &lt;setjmp.h&gt;

       int setjmp(jmp_buf env);
       int sigsetjmp(sigjmp_buf env, int savesigs);
	 
DESCRIPTION
       setjmp()  and  longjmp(3)  are  useful for dealing with errors and interrupts encountered in a low-level subroutine of a program.  
	   
       setjmp() saves the stack context/environment in env for later use by longjmp(3).  The stack context will be invalidated if the function which called setjmp() returns.

	   setjmp() 在参数env中保存栈帧，稍后longjmp调用时，将从setjmp执行；

       sigsetjmp() is similar to setjmp().  If, and only if, savesigs is nonzero, the process's current signal mask is saved in env and will be restored if a siglongjmp(3) is later performed with this env.

RETURN VALUE
       setjmp() and sigsetjmp() return 0 if returning directly, and nonzero when returning from longjmp(3) or siglongjmp(3) using the saved context.

</code></pre>

<h5 id="示例代码">示例代码</h5>

<p><a href="http://blog.linux.org.tw/~jserv/archives/001848.html">代码地址</a> 博客评论区</p>

<pre><code class="language-cpp">#include &lt;stdio.h&gt;                                                                                  
#include &lt;unistd.h&gt;
#include &lt;setjmp.h&gt;

jmp_buf jmpbuf_th0;
jmp_buf jmpbuf_th1;

static int cnt1 = 0;
static int cnt0 = 0;

static void thread_0()
{
	printf(&quot;%s \n\n&quot;, __FUNCTION__);
	sleep(1);
	longjmp(jmpbuf_th0, cnt0++);
}

static void thread_1()
{
	printf(&quot;%s \n\n&quot;, __FUNCTION__);
	sleep(1);
	longjmp(jmpbuf_th1, cnt1++);
}


int main()
{
	int rc0, rc1 = 0;

entry_thread_0:
	rc0 = setjmp(jmpbuf_th0);
	printf(&quot;rc0 = %d\n&quot;, rc0);
	if (rc0 != 0)
		thread_1();
entry_thread_1:
	rc1 = setjmp(jmpbuf_th1);
	printf(&quot;rc1 = %d\n&quot;, rc1);
	thread_0();

	return 0;
}
</code></pre>

<p>执行结果</p>

<pre><code class="language-bash">rc0 = 0
rc1 = 0
thread_0 

rc0 = 1
thread_1 

rc1 = 1
thread_0 

rc0 = 1
thread_1 

rc1 = 1
thread_0 

rc0 = 2
thread_1 

rc1 = 2
thread_0 

rc0 = 3
thread_1 

rc1 = 3
thread_0 

</code></pre>

<ul>
<li><p>执行过程分析</p>

<ul>
<li>setjmp和longjmp都是基于程序空间中额外的jmpbuf</li>
<li>setjmp将当前环境存储在jmpbuf中，longjmp到同一个jmpbuf时，setjmp将会再次返回，返回值是longjmp的第二个参数val</li>
<li>如果setjmp不是因为longjmp返回的，返回值为0</li>
<li>不知道为什么执行结果中，自增的cnt0和cnt1在值为1的时候停顿了一次？</li>
</ul></li>

<li><p><a href="https://github.com/nasrallahmounir/context-switch-setjmp-longjm">setjump &amp; longjmp 进阶实现</a></p></li>

<li><p><a href="https://github.com/mrquincle/event-abbey">setjump &amp; longjmp 进阶实现</a></p></li>
</ul>

<h2 id="ucontext">ucontext</h2>

<h5 id="man-getcontext">man getcontext</h5>

<pre><code class="language-bash">In  a  System  V-like  environment,  one has the two types mcontext_t and ucontext_t defined in &lt;ucontext.h&gt; and the four functions getcontext(), setcontext(), makecontext(3), and swapcontext(3) that
allow user-level context switching between multiple threads of control within a process.

The mcontext_t type is machine-dependent and opaque.  The ucontext_t type is a structure that has at least the following fields:

    typedef struct ucontext {
        struct ucontext *uc_link;
        sigset_t         uc_sigmask;
        stack_t          uc_stack;
        mcontext_t       uc_mcontext;
        ...
    } ucontext_t;

with sigset_t and stack_t defined in &lt;signal.h&gt;.  Here uc_link points to the context that will be resumed when the current context terminates (in case the current context was created  using  makecon‐
text(3)),  uc_sigmask is the set of signals blocked in this context (see sigprocmask(2)), uc_stack is the stack used by this context (see sigaltstack(2)), and uc_mcontext is the machine-specific rep‐
resentation of the saved context, that includes the calling thread's machine registers.

The function getcontext() initializes the structure pointed at by ucp to the currently active context.

The function setcontext() restores the user context pointed at by ucp.  A successful call does not return.  The context should have been obtained by a call  of  getcontext(),  or  makecontext(3),  or
passed as third argument to a signal handler.

If the context was obtained by a call of getcontext(), program execution continues as if this call just returned.

If the context was obtained by a call of makecontext(3), program execution continues by a call to the function func specified as the second argument of that call to makecontext(3).  When the function
func returns, we continue with the uc_link member of the structure ucp specified as the first argument of that call to makecontext(3).  When this member is NULL, the thread exits.

If the context was obtained by a call to a signal handler, then old standard text says that &quot;program execution continues with the program instruction following the instruction interrupted by the sig‐
nal&quot;.  However, this sentence was removed in SUSv2, and the present verdict is &quot;the result is unspecified&quot;.
</code></pre>

<h5 id="man-makecontext">man makecontext</h5>

<pre><code class="language-bash">In  a  System  V-like  environment,  one has the type ucontext_t defined in &lt;ucontext.h&gt; and the four functions getcontext(3), setcontext(3), makecontext() and swapcontext() that allow user-level context switching between multiple threads of control within a
process.

在类System V环境下，结构体ucontext_t和四个函数 getcontext、setcontext、makecontext和swapcontext提供了在一个进程内通过用户级上下文切换的方式实现多线程的方式

For the type and the first two functions, see getcontext(3).

The makecontext() function modifies the context pointed to by ucp (which was obtained from a call to getcontext(3)).  Before invoking makecontext(), the caller must allocate a new stack for this context and assign its address to ucp-&gt;uc_stack, and  define  a
successor context and assign its address to ucp-&gt;uc_link.

makecontext函数将修改ucp指向的 ucontext_t（必须是从getcontext获得的对象），在调用makecontext前，调用者必须为改上下文分配一个新的栈，并将ucp-&gt;uc_stack指向栈的地址，同时将ucp-&gt;uc_link指向下一个context

When  this  context  is  later activated (using setcontext(3) or swapcontext()) the function func is called, and passed the series of integer (int) arguments that follow argc; the caller must specify the number of these arguments in argc.  When this function
returns, the successor context is activated.  If the successor context pointer is NULL, the thread exits.

当该context稍后被激活(通过setcontext或者swapcontext)，makecontext函数参数中的func将被调用，同时向func传递argc个参数。当func返回时，下一个context将被激活调用。如果下一个context是null的话，该线程结束。

The swapcontext() function saves the current context in the structure pointed to by oucp, and then activates the context pointed to by ucp.

swapcontext函数将当前context保存在oucp结构体，同时激活ucp指向的context。
</code></pre>

<h5 id="man-page-中的例子">man page 中的例子</h5>

<pre><code class="language-bash">#include &lt;ucontext.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

static ucontext_t uctx_main, uctx_func1, uctx_func2;

#define handle_error(msg) \
    do { perror(msg); exit(EXIT_FAILURE); } while (0)

static void
func1(void)
{
    printf(&quot;func1: started\n&quot;);
    printf(&quot;func1: swapcontext(&amp;uctx_func1, &amp;uctx_func2)\n&quot;);
    if (swapcontext(&amp;uctx_func1, &amp;uctx_func2) == -1)
        handle_error(&quot;swapcontext&quot;);
    printf(&quot;func1: returning\n&quot;);
}

static void
func2(void)
{
    printf(&quot;func2: started\n&quot;);
    printf(&quot;func2: swapcontext(&amp;uctx_func2, &amp;uctx_func1)\n&quot;);
    if (swapcontext(&amp;uctx_func2, &amp;uctx_func1) == -1)
        handle_error(&quot;swapcontext&quot;);
    printf(&quot;func2: returning\n&quot;);
}

int
main(int argc, char *argv[])
{
    char func1_stack[16384];
    char func2_stack[16384];

    if (getcontext(&amp;uctx_func1) == -1)
        handle_error(&quot;getcontext&quot;);
    uctx_func1.uc_stack.ss_sp = func1_stack;
    uctx_func1.uc_stack.ss_size = sizeof(func1_stack);
    uctx_func1.uc_link = &amp;uctx_main;
    makecontext(&amp;uctx_func1, func1, 0);

    if (getcontext(&amp;uctx_func2) == -1)
        handle_error(&quot;getcontext&quot;);
    uctx_func2.uc_stack.ss_sp = func2_stack;
    uctx_func2.uc_stack.ss_size = sizeof(func2_stack);
    /* Successor context is f1(), unless argc &gt; 1 */
    uctx_func2.uc_link = (argc &gt; 1) ? NULL : &amp;uctx_func1;
    makecontext(&amp;uctx_func2, func2, 0);

    printf(&quot;main: swapcontext(&amp;uctx_main, &amp;uctx_func2)\n&quot;);
    if (swapcontext(&amp;uctx_main, &amp;uctx_func2) == -1)
        handle_error(&quot;swapcontext&quot;);

    printf(&quot;main: exiting\n&quot;);
    exit(EXIT_SUCCESS);
}


// http://stackoverflow.com/questions/20778735/is-the-type-stack-t-no-longer-defined-on-linux

</code></pre>

<p>执行结果：</p>

<pre><code class="language-bash">$ gcc context.c -o context.o

$ ./context.o 
main: swapcontext(&amp;uctx_main, &amp;uctx_func2)
func2: started
func2: swapcontext(&amp;uctx_func2, &amp;uctx_func1)
func1: started
func1: swapcontext(&amp;uctx_func1, &amp;uctx_func2)
func2: returning
func1: returning
main: exiting
</code></pre>

<p>通过manpage中提供的ucontext_t源码，结合man page中的解释，我们对此做一分析。</p>

<ul>
<li>执行过程详解

<ul>
<li>getcontext(&amp;uctx_func2) 用当前上下文初始化ucontext_t结构体对象：uctx_func2</li>
<li>在调用makecontext前，调用者为该上下文分配一个新的栈，并将成员uc_stack指向栈的地址，同时将uc_link指向下一个context。此时argc为0，所以uctx_func2的uc_link指向uctx_func1，也就是说当uctx_func2执行完后，会自动激活uctx_func1执行</li>
<li>makecontext(&amp;uctx_func2, func2, 0) 函数设置当uctx_func2激活时，调用func2函数，参数为0个；当func2返回时，下一个context将被激活，在这里是uctx_func1</li>
<li>swapcontext(&amp;uctx_main, &amp;uctx_func2) 函数将进程当前执行的上下文保存在uctx_main中，并激活uctx_func2；uctx_func2开始执行，首先被执行的是func2函数，

<ul>
<li>func2: started</li>
<li>func2: swapcontext(&amp;uctx_func2, &amp;uctx_func1)</li>
</ul></li>
<li>随后func2函数调用 swapcontext(&amp;uctx_func2, &amp;uctx_func1)，将当前上下文环境保存在uctx_func2中，激活uctx_func1；uctx_func1开始执行，首先执行的是func1，打印出：

<ul>
<li>func1: started</li>
<li>func1: swapcontext(&amp;uctx_func1, &amp;uctx_func2)</li>
</ul></li>
<li>随后func1函数调用swapcontext(&amp;uctx_func1, &amp;uctx_func2)，将当前上下文环境保存在uctx_func1中，并激活uctx_func2；上一次uctx_func2保存的上下文环境将被回复，然后进程执行返回到上次被swap_context的点，打印出:

<ul>
<li>func2: returning</li>
</ul></li>
<li>func2函数返回后，uctx_func2也就返回了，下一个context将被激活，也就是uctx_func1；打印出：

<ul>
<li>func1: returning</li>
</ul></li>
<li>uctx_func1也执行结束，而它的下一个context是uctx_main，在main函数中最开始调用swap_context(&amp;uctx_main, &amp;uctx_func2)时，当时程序执行的上下文的地址就是这句，那么在main中继续执行，打印出：

<ul>
<li>main: exiting</li>
</ul></li>
</ul></li>
</ul>

<pre><code class="language-bash">$ ./context.o x
main: swapcontext(&amp;uctx_main, &amp;uctx_func2)
func2: started
func2: swapcontext(&amp;uctx_func2, &amp;uctx_func1)
func1: started
func1: swapcontext(&amp;uctx_func1, &amp;uctx_func2)
func2: returning
</code></pre>

<ul>
<li>执行过程详解

<ul>
<li>当argc个数不为0时，uctx_func2的uc_link为NULL，所以如果uctx_func2结束生命周期，那么整个进程将会退出</li>
<li>在第一次swap_context(&amp;uctx_main, &amp;uctx_func2)时开始调用func2，func2中打印出：

<ul>
<li>func2: started</li>
<li>func2: swapcontext(&amp;uctx_func2, &amp;uctx_func1)</li>
</ul></li>
<li>随后swap执行uctx_func1，打印：

<ul>
<li>func1: started</li>
<li>func1: swapcontext(&amp;uctx_func1, &amp;uctx_func2)</li>
</ul></li>
<li>随后swap返回uctx_func2，打印：

<ul>
<li>func2: returning</li>
</ul></li>
<li>而func2返回时，由于uctx_func2-&gt;uc_link为NULL，所以整个进程退出，并不会返回到之前保存过的uctx_main执行上下文中。</li>
</ul></li>
</ul>

<p>通过以上分析，您有没有对协程有一个直观的认识呢？本质上，协程调度只是将当前执行的上下文保存起来；调度协程的时候就是将两个执行上下文context切换；指定context的下一个context，在本context执行结束后自动激活下一个context，实现协作；本context执行过程中，通过swap_context主动让出CPU，而不是被抢占放弃CPU。</p>

<ul>
<li>可以参考下<a href="http://courses.cs.vt.edu/~cs3214/spring2016/examples/threads/coroutines.c">进一步的实现</a>，加深下印象：</li>
</ul>

<pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;stdbool.h&gt;
#include &lt;ucontext.h&gt;

static char stack[2][65536];            // a stack for each coroutine
static ucontext_t coroutine_state[2];   // container to remember context

// switch current coroutine (0 -&gt; 1 -&gt; 0 -&gt; 1 ...)
static inline void
yield_to_next(void) 
{
    static int current = 0;

    int prev = current;
    int next = 1 - current;

    current = next;
    swapcontext(&amp;coroutine_state[prev], &amp;coroutine_state[next]);
}

static void
coroutine(int coroutine_number)
{
    int i;
    for (i = 0; i &lt; 5; i++) {
        printf(&quot;Coroutine %d counts i=%d (&amp;i=%p)\n&quot;, coroutine_number, i, &amp;i);
        yield_to_next();
    }
}

int
main()
{
    ucontext_t return_to_main;

    // set up
    int i;
    for (i = 0; i &lt; 2; i++) {
        // initialize ucontext_t
        getcontext(&amp;coroutine_state[i]);
        // set up per-context stack
        coroutine_state[i].uc_stack.ss_sp = stack[i];
        coroutine_state[i].uc_stack.ss_size = sizeof(stack[i]);
        // when done, resume 'return_to_main' context
        coroutine_state[i].uc_link = &amp;return_to_main;
        // let context[i] perform a call to coroutine(i) when swapped to
        makecontext(&amp;coroutine_state[i], (void (*)(void))coroutine, 1, i);
    }

    printf(&quot;Starting coroutines...\n&quot;);
    swapcontext(&amp;return_to_main, &amp;coroutine_state[0]);
    printf(&quot;Done.\n&quot;);
    return 0;
}
</code></pre>

<ul>
<li><p><a href="http://1234n.com/?post/aukxju">another demo</a></p>

<ul>
<li><a href="http://1234n.com/?post/4vzsvm">lib</a></li>
</ul></li>

<li><p><a href="https://www.gnu.org/software/pth/">gnu portable threads</a></p>

<ul>
<li><a href="http://www.ossp.org/pkg/lib/pth/">pt</a></li>
</ul></li>

<li><p><a href="https://swtch.com/libtask/">libtask</a></p>

<ul>
<li><a href="http://www.cnblogs.com/foxmailed/p/3509359.html">libtask的coroutine</a></li>
</ul></li>

<li><p><a href="https://github.com/cloudwu/coroutine">云风的实现</a></p></li>

<li><p>其他一些应用</p>

<ul>
<li><a href="https://github.com/colaghost/coroutine_event">coroutine-libevent</a>

<ul>
<li>在libevent里通过协程实现同步</li>
</ul></li>
</ul></li>
</ul>

<h2 id="lua的协程">Lua的协程</h2>

<ul>
<li><p>lua不支持那种真正的多线程（共享同一地址空间的抢占式线程），原因是</p>

<ul>
<li>ANSI C没有原生的多线程，所以lua不能直接调用实现</li>
<li>最重要的原因是，我们不认为多线程在lua中是个好主意</li>
</ul></li>

<li><p>多线程是提供给底层编程的。多线程的同步机制，比如信号量和监控都是在操作系统上下文实现的，而非应用程序。调试多线程比较麻烦。而且，由于程序临界区的同步和竞争，多线程也会引起性能下降。</p></li>

<li><p>多线程引起的问题，主要是抢占式线程和共享内存导致的，lua解决这两个问题的方法是：lua coroutine是协作式的，非抢占式的，所以能避免线程切换导致的问题；lua coroutine之间不共享内存。</p></li>

<li><p>我见过的最lua的<a href="https://techsingular.org/2012/12/22/programming-in-lua%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%8D-nil-%E5%92%8C-list/">lua代码和博客</a></p></li>

<li><p>lua的<a href="https://techsingular.org/2013/05/09/programming-in-lua%EF%BC%88%E4%BA%94%EF%BC%89%EF%BC%8D-coroutine-lua-stack/">coroutine and stack</a></p></li>

<li><p>lua的c runtime stack和lua runtime stack是<a href="https://techsingular.org/2013/07/14/programming-in-lua%EF%BC%88%E5%85%AD%EF%BC%89%EF%BC%8Dcontinuation/">什么样子的</a></p></li>

<li><p><a href="https://www.zhihu.com/question/21483863">https://www.zhihu.com/question/21483863</a></p></li>

<li><p><a href="https://www.zhihu.com/question/30133749">lua协程调度</a></p>

<ul>
<li>lua内部

<ul>
<li>当resume的时候，就切换lua_state环境，然后setjmp，紧接着由于pc指向新地址，所以会直接跳转到该位置</li>
<li>当yield时，直接回复环境，然后longjmp到该resume点</li>
</ul></li>
<li>lua with C

<ul>
<li>当在C函数内入yield时，会恢复环境，longjmp到resume点，之后再次resume的时候，会因为环境被破坏，导致resume出错，此时lua会调用k系列函数，让resume继续下去
<br /></li>
</ul></li>
</ul></li>

<li><p><a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-python-yield/">lua实现调度器</a></p></li>

<li><p><a href="https://www.lua.org/pil/9.2.html">consumer-producer</a></p></li>

<li><p><a href="http://www.lua.org/manual/5.2/manual.html#2.6">lua yield 和 resume</a></p>

<ul>
<li><a href="http://www.lua.org/manual/5.2/manual.html#pdf-coroutine.resume">http://www.lua.org/manual/5.2/manual.html#pdf-coroutine.resume</a></li>
</ul></li>
</ul>

<pre><code class="language-lua">-- http://my.oschina.net/wangxuanyihaha/blog/186401

function foo(a)
    print(&quot;foo&quot;, a)
    return coroutine.yield(2 * a)
end

co = coroutine.create(function ( a, b )
    print(&quot;co-body&quot;, a, b)
    local r = foo(a + 1)
    print(&quot;co-body&quot;, r)
    local r, s = coroutine.yield(a + b, a - b)
    print(&quot;co-body&quot;, r, s)
    return b, &quot;end&quot;
end)

print(&quot;main&quot;, coroutine.resume(co, 1, 10))
print(&quot;main&quot;, coroutine.resume(co, &quot;m&quot;))	-- resume的参数 'm' 是在调用yield传入的，所以本次是在第5行 return m
print(&quot;main&quot;, coroutine.resume(co, &quot;x&quot;, &quot;y&quot;))
print(&quot;main&quot;, coroutine.resume(co, &quot;x&quot;, &quot;y&quot;))
</code></pre>

<pre><code class="language-bash">co-body	1	10
foo	2
main	true	4
co-body	m
main	true	11	-9
co-body	x	y
main	true	10	end
main	false	cannot resume dead coroutine
</code></pre>

<h2 id="python的协程-待续">python的协程(待续)</h2>

<ul>
<li><a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-python-yield/">http://www.ibm.com/developerworks/cn/opensource/os-cn-python-yield/</a>

<ul>
<li>简单地讲，yield 的作用就是把一个函数变成一个 generator，带有 yield 的函数不再是一个普通函数，Python 解释器会将其视为一个 generator</li>
<li>产生一个iterable对象</li>
</ul></li>
</ul>

<h2 id="golang的协程-待续">golang的协程(待续)</h2>

<ul>
<li><a href="http://stackoverflow.com/questions/13107958/what-exactly-does-runtime-gosched-do">http://stackoverflow.com/questions/13107958/what-exactly-does-runtime-gosched-do</a></li>
</ul>

<h2 id="stm32-contiki-coroutine">stm32/ contiki/ coroutine</h2>

<p><a href="http://wiki.csie.ncku.edu.tw/embedded/Lab2">stm32上的协程实现</a>
    * <a href="http://blog.linux.org.tw/~jserv/archives/001848.html">http://blog.linux.org.tw/~jserv/archives/001848.html</a></p>

    <div id="social-bar">
	<ul class="rrssb-buttons clearfix">
      <li class="email">
          <a href="mailto:?subject=coroutine%20and%20goroutine&amp;body=https://bg2bkk.github.io/post/coroutine%20and%20goroutine/">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path transform="scale(0.014,-0.014) translate(0,-1670)" d="M1792 826v-794q0 -66 -47 -113t-113 -47h-1472q-66 0 -113 47t-47 113v794q44 -49 101 -87q362 -246 497 -345q57 -42 92.5 -65.5t94.5 -48t110 -24.5h1h1q51 0 110 24.5t94.5 48t92.5 65.5q170 123 498 345q57 39 100 87zM1792 1120q0 -79 -49 -151t-122 -123 q-376 -261 -468 -325q-10 -7 -42.5 -30.5t-54 -38t-52 -32.5t-57.5 -27t-50 -9h-1h-1q-23 0 -50 9t-57.5 27t-52 32.5t-54 38t-42.5 30.5q-91 64 -262 182.5t-205 142.5q-62 42 -117 115.5t-55 136.5q0 78 41.5 130t118.5 52h1472q65 0 112.5 -47t47.5 -113z"/>
                  </svg>
              </span>
              <span class="text">Email</span>
          </a>
      </li>
      <li class="facebook">
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://bg2bkk.github.io/post/coroutine%20and%20goroutine/" class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path d="M27.825,4.783c0-2.427-2.182-4.608-4.608-4.608H4.783c-2.422,0-4.608,2.182-4.608,4.608v18.434 c0,2.427,2.181,4.608,4.608,4.608H14V17.379h-3.379v-4.608H14v-1.795c0-3.089,2.335-5.885,5.192-5.885h3.718v4.608h-3.726 c-0.408,0-0.884,0.492-0.884,1.236v1.836h4.609v4.608h-4.609v10.446h4.916c2.422,0,4.608-2.188,4.608-4.608V4.783z"/>
                  </svg>
              </span>
              <span class="text">Facebook</span>
          </a>
      </li>
			<li class="twitter">
          <a href="http://twitter.com/home?status=coroutine%20and%20goroutine%20https://bg2bkk.github.io/post/coroutine%20and%20goroutine/" class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
		                  <path d="M24.253,8.756C24.689,17.08,18.297,24.182,9.97,24.62c-3.122,0.162-6.219-0.646-8.861-2.32 c2.703,0.179,5.376-0.648,7.508-2.321c-2.072-0.247-3.818-1.661-4.489-3.638c0.801,0.128,1.62,0.076,2.399-0.155 C4.045,15.72,2.215,13.6,2.115,11.077c0.688,0.275,1.426,0.407,2.168,0.386c-2.135-1.65-2.729-4.621-1.394-6.965 C5.575,7.816,9.54,9.84,13.803,10.071c-0.842-2.739,0.694-5.64,3.434-6.482c2.018-0.623,4.212,0.044,5.546,1.683 c1.186-0.213,2.318-0.662,3.329-1.317c-0.385,1.256-1.247,2.312-2.399,2.942c1.048-0.106,2.069-0.394,3.019-0.851 C26.275,7.229,25.39,8.196,24.253,8.756z"/>
                  </svg>
              </span>
              <span class="text">Twitter</span>
          </a>
      </li>
			<li class="linkedin">
          <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=https://bg2bkk.github.io/post/coroutine%20and%20goroutine/&amp;title=coroutine%20and%20goroutine&amp;summary=%e5%8d%8f%e7%a8%8b%e6%98%af%e4%bb%80%e4%b9%88%ef%bc%9f%20what%20is%20coroutine%20%3f%20%20%e5%8d%8f%e7%a8%8b%e7%9a%84%e6%a6%82%e5%bf%b5%20%20%20Coroutines%20are%20computer%20program%20components%20that%20generalize%20subroutines%20for%20nonpreemptive%20multitasking%2c%20by%20allowing%20multiple%20entry%20points%20for%20suspending%20and%20resuming%20execution%20at%20certain%20locations.%20Coroutines%20are%20well-suited%20for%20implementing%20more%20familiar%20program%20components%20such%20as%20cooperative%20tasks%2c%20exceptions%2c%20event%20loop%2c%20iterators%2c%20infinite%20lists%20and%20pipes.%0aAccording%20to%20Donald%20Knuth%2c%20the%20term%20coroutine%20was%20coined%20by%20Melvin%20Conway%20in%201958%2c%20after%20he%20applied%20it%20to%20construction%20of%20an%20assembly%20program...." class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path d="M25.424,15.887v8.447h-4.896v-7.882c0-1.979-0.709-3.331-2.48-3.331c-1.354,0-2.158,0.911-2.514,1.803 c-0.129,0.315-0.162,0.753-0.162,1.194v8.216h-4.899c0,0,0.066-13.349,0-14.731h4.899v2.088c-0.01,0.016-0.023,0.032-0.033,0.048 h0.033V11.69c0.65-1.002,1.812-2.435,4.414-2.435C23.008,9.254,25.424,11.361,25.424,15.887z M5.348,2.501 c-1.676,0-2.772,1.092-2.772,2.539c0,1.421,1.066,2.538,2.717,2.546h0.032c1.709,0,2.771-1.132,2.771-2.546 C8.054,3.593,7.019,2.501,5.343,2.501H5.348z M2.867,24.334h4.897V9.603H2.867V24.334z"/>
                  </svg>
              </span>
              <span class="text">LinkedIn</span>
          </a>
      </li>
      <li class="tumblr">
					<script>
						document.write('<a href="http://www.tumblr.com/share?v=3&amp;u=' + encodeURIComponent('https:\/\/bg2bkk.github.io\/post\/coroutine%20and%20goroutine\/') + '&amp;t=coroutine and goroutine" class="popup">');
					</script>
              <span class="icon">
                  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
											<path d="M18.02 21.842c-2.029 0.052-2.422-1.396-2.439-2.446v-7.294h4.729V7.874h-4.71V1.592c0 0-3.653 0-3.714 0 s-0.167 0.053-0.182 0.186c-0.218 1.935-1.144 5.33-4.988 6.688v3.637h2.927v7.677c0 2.8 1.7 6.7 7.3 6.6 c1.863-0.03 3.934-0.795 4.392-1.453l-1.22-3.539C19.595 21.6 18.7 21.8 18 21.842z"/>
									</svg>
              </span>
              <span class="text">Tumblr</span>
          <script>document.write('</a>');</script>
      </li>
      <li class="reddit">
          <a href="http://www.reddit.com/submit?url=https://bg2bkk.github.io/post/coroutine%20and%20goroutine/">
              <span class="icon">
                  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
											<g>
													<path d="M11.794 15.316c0-1.029-0.835-1.895-1.866-1.895c-1.03 0-1.893 0.865-1.893 1.895s0.863 1.9 1.9 1.9 C10.958 17.2 11.8 16.3 11.8 15.316z"/>
													<path d="M18.1 13.422c-1.029 0-1.895 0.864-1.895 1.895c0 1 0.9 1.9 1.9 1.865c1.031 0 1.869-0.836 1.869-1.865 C19.969 14.3 19.1 13.4 18.1 13.422z"/>
													<path d="M17.527 19.791c-0.678 0.678-1.826 1.006-3.514 1.006c-0.004 0-0.009 0-0.014 0c-0.004 0-0.01 0-0.015 0 c-1.686 0-2.834-0.328-3.51-1.005c-0.264-0.265-0.693-0.265-0.958 0c-0.264 0.265-0.264 0.7 0 1 c0.943 0.9 2.4 1.4 4.5 1.402c0.005 0 0 0 0 0c0.005 0 0 0 0 0c2.066 0 3.527-0.459 4.47-1.402 c0.265-0.264 0.265-0.693 0.002-0.958C18.221 19.5 17.8 19.5 17.5 19.791z"/>
													<path d="M27.707 13.267c0-1.785-1.453-3.237-3.236-3.237c-0.793 0-1.518 0.287-2.082 0.761c-2.039-1.295-4.646-2.069-7.438-2.219 l1.483-4.691l4.062 0.956c0.071 1.4 1.3 2.6 2.7 2.555c1.488 0 2.695-1.208 2.695-2.695C25.881 3.2 24.7 2 23.2 2 c-1.059 0-1.979 0.616-2.42 1.508l-4.633-1.091c-0.344-0.081-0.693 0.118-0.803 0.455l-1.793 5.7 C10.548 8.6 7.7 9.4 5.6 10.75C5.006 10.3 4.3 10 3.5 10.029c-1.785 0-3.237 1.452-3.237 3.2 c0 1.1 0.6 2.1 1.4 2.69c-0.04 0.272-0.061 0.551-0.061 0.831c0 2.3 1.3 4.4 3.7 5.9 c2.299 1.5 5.3 2.3 8.6 2.325c3.228 0 6.271-0.825 8.571-2.325c2.387-1.56 3.7-3.66 3.7-5.917 c0-0.26-0.016-0.514-0.051-0.768C27.088 15.5 27.7 14.4 27.7 13.267z M23.186 3.355c0.74 0 1.3 0.6 1.3 1.3 c0 0.738-0.6 1.34-1.34 1.34s-1.342-0.602-1.342-1.34C21.844 4 22.4 3.4 23.2 3.355z M1.648 13.3 c0-1.038 0.844-1.882 1.882-1.882c0.31 0 0.6 0.1 0.9 0.209c-1.049 0.868-1.813 1.861-2.26 2.9 C1.832 14.2 1.6 13.8 1.6 13.267z M21.773 21.57c-2.082 1.357-4.863 2.105-7.831 2.105c-2.967 0-5.747-0.748-7.828-2.105 c-1.991-1.301-3.088-3-3.088-4.782c0-1.784 1.097-3.484 3.088-4.784c2.081-1.358 4.861-2.106 7.828-2.106 c2.967 0 5.7 0.7 7.8 2.106c1.99 1.3 3.1 3 3.1 4.784C24.859 18.6 23.8 20.3 21.8 21.57z M25.787 14.6 c-0.432-1.084-1.191-2.095-2.244-2.977c0.273-0.156 0.59-0.245 0.928-0.245c1.035 0 1.9 0.8 1.9 1.9 C26.354 13.8 26.1 14.3 25.8 14.605z"/>
											</g>
									</svg>
              </span>
              <span class="text">Reddit</span>
          </a>
      </li>
      <li class="googleplus">
          <a href="https://plus.google.com/share?url=https://bg2bkk.github.io/post/coroutine%20and%20goroutine/" class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <g>
                          <path d="M14.703,15.854l-1.219-0.948c-0.372-0.308-0.88-0.715-0.88-1.459c0-0.748,0.508-1.223,0.95-1.663 c1.42-1.119,2.839-2.309,2.839-4.817c0-2.58-1.621-3.937-2.399-4.581h2.097l2.202-1.383h-6.67c-1.83,0-4.467,0.433-6.398,2.027 C3.768,4.287,3.059,6.018,3.059,7.576c0,2.634,2.022,5.328,5.604,5.328c0.339,0,0.71-0.033,1.083-0.068 c-0.167,0.408-0.336,0.748-0.336,1.324c0,1.04,0.551,1.685,1.011,2.297c-1.524,0.104-4.37,0.273-6.467,1.562 c-1.998,1.188-2.605,2.916-2.605,4.137c0,2.512,2.358,4.84,7.289,4.84c5.822,0,8.904-3.223,8.904-6.41 c0.008-2.327-1.359-3.489-2.829-4.731H14.703z M10.269,11.951c-2.912,0-4.231-3.765-4.231-6.037c0-0.884,0.168-1.797,0.744-2.511 c0.543-0.679,1.489-1.12,2.372-1.12c2.807,0,4.256,3.798,4.256,6.242c0,0.612-0.067,1.694-0.845,2.478 c-0.537,0.55-1.438,0.948-2.295,0.951V11.951z M10.302,25.609c-3.621,0-5.957-1.732-5.957-4.142c0-2.408,2.165-3.223,2.911-3.492 c1.421-0.479,3.25-0.545,3.555-0.545c0.338,0,0.52,0,0.766,0.034c2.574,1.838,3.706,2.757,3.706,4.479 c-0.002,2.073-1.736,3.665-4.982,3.649L10.302,25.609z"/>
                          <polygon points="23.254,11.89 23.254,8.521 21.569,8.521 21.569,11.89 18.202,11.89 18.202,13.604 21.569,13.604 21.569,17.004 23.254,17.004 23.254,13.604 26.653,13.604 26.653,11.89"/>
                      </g>
                  </svg>
              </span>
              <span class="text">Google+</span>
          </a>
      </li>
      <li class="pinterest">
          <script>
						var imgurl = "https:\/\/bg2bkk.github.io\/logo.png";
						var firstimg = document.getElementsByClassName("post")[0].getElementsByTagName("img")[0];
						if (firstimg !== undefined) {
							imgurl = firstimg.src;
						}
						document.write('<a href="http://pinterest.com/pin/create/button/?url=https:\/\/bg2bkk.github.io\/post\/coroutine%20and%20goroutine\/&amp;media=' + imgurl + '&amp;description=coroutine and goroutine" class="popup">');
					</script>
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
		                  <path d="M14.021,1.57C6.96,1.57,1.236,7.293,1.236,14.355c0,7.062,5.724,12.785,12.785,12.785c7.061,0,12.785-5.725,12.785-12.785 C26.807,7.294,21.082,1.57,14.021,1.57z M15.261,18.655c-1.161-0.09-1.649-0.666-2.559-1.219c-0.501,2.626-1.113,5.145-2.925,6.458 c-0.559-3.971,0.822-6.951,1.462-10.116c-1.093-1.84,0.132-5.545,2.438-4.632c2.837,1.123-2.458,6.842,1.099,7.557 c3.711,0.744,5.227-6.439,2.925-8.775c-3.325-3.374-9.678-0.077-8.897,4.754c0.19,1.178,1.408,1.538,0.489,3.168 C7.165,15.378,6.53,13.7,6.611,11.462c0.131-3.662,3.291-6.227,6.46-6.582c4.007-0.448,7.771,1.474,8.29,5.239 c0.579,4.255-1.816,8.865-6.102,8.533L15.261,18.655z"/>
                  </svg>
              </span>
              <span class="text">Pinterest</span>
          <script>document.write('</a>');</script>
      </li>
      <li class="pocket">
          <a href="https://getpocket.com/save?url=https://bg2bkk.github.io/post/coroutine%20and%20goroutine/"  class="popup">
              <span class="icon">
                  <svg width="32px" height="28px" viewBox="0 0 32 28" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                      <path d="M28.7817528,0.00172488695 C30.8117487,0.00431221738 31.9749312,1.12074529 31.9644402,3.10781507 C31.942147,6.67703739 32.1336065,10.2669583 31.8057648,13.8090137 C30.7147076,25.5813672 17.2181194,31.8996281 7.20714461,25.3808491 C2.71833574,22.4571656 0.196577202,18.3122624 0.0549495772,12.9357897 C-0.0342233715,9.5774348 0.00642900214,6.21519891 0.0300336062,2.85555035 C0.0405245414,1.1129833 1.21157517,0.0146615391 3.01995012,0.00819321302 C7.34746087,-0.00603710433 11.6775944,0.00431221738 16.0064164,0.00172488695 C20.2644248,0.00172488695 24.5237444,-0.00215610869 28.7817528,0.00172488695 L28.7817528,0.00172488695 Z M8.64885184,7.85611511 C7.38773662,7.99113854 6.66148108,8.42606978 6.29310958,9.33228474 C5.90114134,10.2969233 6.17774769,11.1421181 6.89875951,11.8276216 C9.35282156,14.161969 11.8108164,16.4924215 14.2976518,18.7943114 C15.3844131,19.7966007 16.5354102,19.7836177 17.6116843,18.7813283 C20.0185529,16.5495467 22.4070683,14.2982907 24.7824746,12.0327533 C25.9845979,10.8850542 26.1012707,9.56468083 25.1469132,8.60653379 C24.1361858,7.59255976 22.8449191,7.6743528 21.5890476,8.85191291 C19.9936451,10.3488554 18.3680912,11.8172352 16.8395462,13.3777945 C16.1342655,14.093159 15.7200114,14.0048744 15.0566806,13.3440386 C13.4599671,11.7484252 11.8081945,10.2060421 10.1262706,8.70001155 C9.65564653,8.27936164 9.00411403,8.05345704 8.64885184,7.85611511 L8.64885184,7.85611511 L8.64885184,7.85611511 Z"></path>
                  </svg>
              </span>
              <span class="text">Pocket</span>
          </a>
      </li>
  </ul>
</div>

    <div itemprop="author" itemscope itemtype="http://schema.org/Person">
  <h5>about the author</h5>
  <section>

	<p>如果关于本文您有兴趣，我们可以进一步探讨、交流和学习。我的email是 bg2bkk # gmail.com. 欢迎交流</p>
  </section>
</div>

    <div id="comments">
    
    
    
    
</div>

</article>

</main>
		<footer id="footer">
			<section id="footer-message">&copy; BG2BKK Site. All rights reserved. Powered by <a href="http://gohugo.io" target="_blank">Hugo</a>. <a href="https://github.com/kathyqian/crisp-ghost-theme" target="_blank">Crisp</a> theme by <a href="http://kathyqian.com" target="_blank">Kathy Qian</a>.</section>
		</footer>

    <script>
      (function(c,f){asyncLoader=function(i,h){i.foreach(function(k,j){e(j,d(j),h)});if(typeof h.callback=="function"){var g=setInterval(function(){if(f.readyState==="complete"){clearInterval(g);h.callback()}},10)}};var d=function(g){var h=g.split(".");return h[h.length-1]},e=function(h,i,g){switch(i){case"js":a(h,g);break;case"css":b(h);break;default:break}},a=function(i,h){var g=document.createElement("script");g.type="text/javascript";g.async=true;g.src=i;document.getElementsByTagName("head")[0].appendChild(g)},b=function(g){var h=document.createElement("link");h.type="text/css";h.rel="stylesheet";h.href=g;document.getElementsByTagName("head")[0].appendChild(h)};Array.prototype.foreach=function(h){for(var g=0;g<this.length;g++){h(g,this[g])}}})(this,document);

      var WebFontConfig={google:{families:["Open Sans:300italic,700italic,300,700","Bree+Serif"]}};
      asyncLoader([
        "//netdna.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.css",
        "//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js",
        "//cdnjs.cloudflare.com/ajax/libs/webfont/1.5.16/webfontloader.js",
        "//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"
      ],{
        callback:function(){
          asyncLoader([
            "https:\/\/bg2bkk.github.io\/css/rrssb.css",
            "https:\/\/bg2bkk.github.io\/js/gist.min.js", 
            "https:\/\/bg2bkk.github.io\/js/rrssb.min.js",
            "//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/default.min.css"
          ], { callback:function() {
              hljs.initHighlighting();
          }});
        }
      });
    </script>
	
	</body>
</html>

<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='åç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ what is coroutine ? åç¨‹çš„æ¦‚å¿µ Coroutines are computer program components that generalize subroutines for nonpreemptive multitasking, by allowing multiple entry points for suspending and resuming execution at certain locations. Coroutines are well-suited for implementing more familiar program components such as cooperative tasks, exceptions, event loop, iterators, infinite lists and pipes.
According to Donald Knuth, the term coroutine was coined by Melvin Conway in 1958, after he applied it to construction of an assembly program.'>
<title>coroutine and goroutine</title>

<link rel='canonical' href='https://bg2bkk.github.io/p/coroutine-and-goroutine/'>

<link rel="stylesheet" href="/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css"><meta property='og:title' content='coroutine and goroutine'>
<meta property='og:description' content='åç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ what is coroutine ? åç¨‹çš„æ¦‚å¿µ Coroutines are computer program components that generalize subroutines for nonpreemptive multitasking, by allowing multiple entry points for suspending and resuming execution at certain locations. Coroutines are well-suited for implementing more familiar program components such as cooperative tasks, exceptions, event loop, iterators, infinite lists and pipes.
According to Donald Knuth, the term coroutine was coined by Melvin Conway in 1958, after he applied it to construction of an assembly program.'>
<meta property='og:url' content='https://bg2bkk.github.io/p/coroutine-and-goroutine/'>
<meta property='og:site_name' content='Bg2bkk Site'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2016-03-13T17:59:29&#43;08:00'/><meta property='article:modified_time' content='2016-03-13T17:59:29&#43;08:00'/>
<meta name="twitter:title" content="coroutine and goroutine">
<meta name="twitter:description" content="åç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ what is coroutine ? åç¨‹çš„æ¦‚å¿µ Coroutines are computer program components that generalize subroutines for nonpreemptive multitasking, by allowing multiple entry points for suspending and resuming execution at certain locations. Coroutines are well-suited for implementing more familiar program components such as cooperative tasks, exceptions, event loop, iterators, infinite lists and pipes.
According to Donald Knuth, the term coroutine was coined by Melvin Conway in 1958, after he applied it to construction of an assembly program.">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu9dfb7228514195dbb950046570d90a5c_100216_300x0_resize_q75_box.jpg" width="300"
                            height="221" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Bg2bkk Site</a></h1>
            <h2 class="site-description">Life is so beautiful</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/bg2bkk'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/%E5%85%B3%E4%BA%8E%E6%88%91/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äºæˆ‘</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li>
          <ol>
            <li><a href="#åç¨‹æ˜¯ä»€ä¹ˆ-what-is-coroutine-">åç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ what is coroutine ?</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#setjump--longjmp">setjump &amp; longjmp</a>
      <ol>
        <li>
          <ol>
            <li></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#ucontext">ucontext</a>
      <ol>
        <li>
          <ol>
            <li></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#luaçš„åç¨‹">Luaçš„åç¨‹</a></li>
    <li><a href="#pythonçš„åç¨‹å¾…ç»­">pythonçš„åç¨‹(å¾…ç»­)</a></li>
    <li><a href="#golangçš„åç¨‹å¾…ç»­">golangçš„åç¨‹(å¾…ç»­)</a></li>
    <li><a href="#stm32-contiki-coroutine">stm32/ contiki/ coroutine</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/coroutine-and-goroutine/">coroutine and goroutine</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Mar 13, 2016</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    11 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h4 id="åç¨‹æ˜¯ä»€ä¹ˆ-what-is-coroutine-">åç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ what is coroutine ?</h4>
<ul>
<li><a class="link" href="https://en.wikipedia.org/wiki/Coroutine"  target="_blank" rel="noopener"
    >åç¨‹çš„æ¦‚å¿µ</a></li>
</ul>
<blockquote>
<p>Coroutines are computer program components that generalize subroutines for nonpreemptive multitasking, by allowing multiple entry points for suspending and resuming execution at certain locations. Coroutines are well-suited for implementing more familiar program components such as cooperative tasks, exceptions, event loop, iterators, infinite lists and pipes.</p>
</blockquote>
<blockquote>
<p>According to Donald Knuth, the term coroutine was coined by Melvin Conway in 1958, after he applied it to construction of an assembly program.[1] The first published explanation of the coroutine appeared later, in 1963.[2]</p>
</blockquote>
<p>åç¨‹æ˜¯ä¸ºå®ç°éæŠ¢å å¼å¤šä»»åŠ¡è€Œæå‡ºçš„è®¡ç®—æœºå­ç¨‹åºï¼Œé€šè¿‡æä¾›å¤šä¸ªç¨‹åºå…¥å£ä½¿å¾—ç¨‹åºå¯ä»¥åœ¨ç‰¹å®šåœ°å€æŒ‚èµ·å’Œæ¢å¤æ‰§è¡Œã€‚åç¨‹å¤©ç”Ÿçš„æ”¯æŒå®ç°å¸¸è§ç¨‹åºç»„ä»¶ï¼Œæ¯”å¦‚åä½œå¼ä»»åŠ¡ã€å¼‚å¸¸ã€æ—¶é—´å¾ªç¯ã€è¿­ä»£å™¨ã€æ— è¾¹ç•Œåˆ—è¡¨å’Œç®¡é“ç­‰ã€‚</p>
<p>æ ¹æ®ç¥–å¸ˆçˆ·é«˜çº³å¾·èŠ‚è¯´ï¼Œåç¨‹çš„æ¦‚å¿µç”±Melvin Conwayåœ¨1958å¹´æå‡ºï¼Œéšåä»–å°†åç¨‹åº”ç”¨åœ¨ç¼–å†™æ±‡ç¼–ç¨‹åºä¸Šã€‚åç¨‹çš„ç¬¬ä¸€ä¸ªå…¬å¼€å‘è¡¨çš„è§£é‡Šå‡ºç°åœ¨1963å¹´ã€‚</p>
<p>å¯è§åç¨‹çš„æ¦‚å¿µæ¯”å¤šçº¿ç¨‹è¿˜æ—©ï¼Œè€Œä¸”æŒ‰ç…§Knuthçš„è¯´æ³•ï¼Œ<a class="link" href="http://coolshell.cn/articles/10975.html"  target="_blank" rel="noopener"
    >â€å­ä¾‹ç¨‹æ˜¯åç¨‹çš„ç‰¹ä¾‹â€œï¼Œä¸€æ¬¡å­ä¾‹ç¨‹è°ƒç”¨å°±æ˜¯ä¸€æ¬¡å­å‡½æ•°è°ƒç”¨</a>ï¼Œåç¨‹æ˜¯ç±»å‡½æ•°ä¸€æ ·çš„ç»„ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å•çº¿ç¨‹ä¸­åˆ›å»ºNå¤šä¸ªåç¨‹ï¼Œåªè¦å†…å­˜å¤Ÿç”¨ã€‚</p>
<pre><code>* åç¨‹ä¸å­ä¾‹ç¨‹çš„[åŒºåˆ«](https://en.wikipedia.org/wiki/Coroutine)
	* å­ä¾‹ç¨‹åªæœ‰ä¸€ä¸ªè°ƒç”¨å…¥å£èµ·ç‚¹ï¼Œå­ä¾‹ç¨‹é€€å‡ºåï¼Œæ‰§è¡Œç»“æŸï¼›å­ä¾‹ç¨‹åªè¿”å›ä¸€æ¬¡ï¼Œåœ¨ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´ä¸ä¿å­˜çŠ¶æ€ï¼›
	* åç¨‹æœ‰å¤šä¸ªå…¥å£ï¼Œè°ƒç”¨èµ·å§‹ç‚¹ã€æˆ–è€…ä»ä¸Šä¸€æ¬¡è¿”å›ç‚¹æ¥ç€æ‰§è¡Œï¼›ä»åç¨‹è‡ªå·±çš„è§’åº¦æ¥çœ‹ï¼Œä»–æ”¾å¼ƒæ‰§è¡Œæ—¶ä¸æ˜¯é€€å‡ºï¼Œè€Œæ˜¯å»è°ƒç”¨å¦ä¸€ä¸ªåç¨‹ï¼Œæˆ–è€…è¯´å°†CPUä¸»åŠ¨è®©ç»™å¦ä¸€ä¸ªåç¨‹ï¼›åç¨‹ä¿å­˜çŠ¶æ€;
		* è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œ[yield](https://en.wikipedia.org/wiki/Yield_(multithreading))ç”¨äºä½¿å¤„ç†å™¨æ”¾å¼ƒå½“å‰è¿è¡Œçš„çº¿ç¨‹threadï¼Œå¹¶å°†å®ƒæ”¾å…¥è¿è¡Œé˜Ÿåˆ—çš„æœ«å°¾
		* åç¨‹coroutineä¸­çš„yieldéœ€è¦æ˜¾å¼è°ƒç”¨
	* æ¯ä¸ªå­ä¾‹ç¨‹å¯ä»¥è½¬æ¢ä¸ºä¸€ä¸ªä¸å¸¦yieldçš„åç¨‹
</code></pre>
<p>åç¨‹æœ‰å…³çš„å››ä¸ªæ¦‚å¿µï¼š<a class="link" href="https://en.wikipedia.org/wiki/Coroutine"  target="_blank" rel="noopener"
    >coroutine</a>ã€[yield](<a class="link" href="https://en.wikipedia.org/wiki/Yield_%28multithreading%29"  target="_blank" rel="noopener"
    >https://en.wikipedia.org/wiki/Yield_(multithreading)</a>ã€<a class="link" href="https://en.wikipedia.org/wiki/Continuation"  target="_blank" rel="noopener"
    >Continuation</a>ã€<a class="link" href="https://en.wikipedia.org/wiki/Cooperative_multitasking"  target="_blank" rel="noopener"
    >cooperative multitasking</a>ã€‚ä»¥åŠå…¶ä»–ç›¸å…³æ¦‚å¿µï¼š<a class="link" href="https://en.wikipedia.org/wiki/Call_stack#Unwinding"  target="_blank" rel="noopener"
    >call stack</a></p>
<ul>
<li><a class="link" href="http://www.chiark.greenend.org.uk/~sgtatham/coroutines.html"  target="_blank" rel="noopener"
    >Coroutines in C</a>
<ul>
<li><a class="link" href="http://www.hawkwithwind.net/blog/2011/02/18/%E5%8D%8F%E7%A8%8B%E7%9A%84c%E5%AE%9E%E7%8E%B0/"  target="_blank" rel="noopener"
    >ç»™ä½ ä¸€ä¸ªç›´è§‚çš„è®¤è¯†</a></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">function</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">static</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="k">goto</span> <span class="n">LABEL0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="k">goto</span> <span class="n">LABEL1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">LABEL0</span><span class="p">:</span> <span class="cm">/* start of function */</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\t\t\t</span><span class="s">i = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* so we will come back to LABEL1 */</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">LABEL1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span> <span class="cm">/* resume control straight after the return */</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;j = %d, func = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">function</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰§è¡Œç»“æœ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">			<span class="nv">i</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 0, <span class="nv">func</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">			<span class="nv">i</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 1, <span class="nv">func</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">			<span class="nv">i</span> <span class="o">=</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 2, <span class="nv">func</span> <span class="o">=</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">			<span class="nv">i</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 3, <span class="nv">func</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">			<span class="nv">i</span> <span class="o">=</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 4, <span class="nv">func</span> <span class="o">=</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl">			<span class="nv">i</span> <span class="o">=</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 5, <span class="nv">func</span> <span class="o">=</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl">			<span class="nv">i</span> <span class="o">=</span> <span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 6, <span class="nv">func</span> <span class="o">=</span> <span class="m">6</span>
</span></span><span class="line"><span class="cl">			<span class="nv">i</span> <span class="o">=</span> <span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 7, <span class="nv">func</span> <span class="o">=</span> <span class="m">7</span>
</span></span><span class="line"><span class="cl">			<span class="nv">i</span> <span class="o">=</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 8, <span class="nv">func</span> <span class="o">=</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl">			<span class="nv">i</span> <span class="o">=</span> <span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 9, <span class="nv">func</span> <span class="o">=</span> <span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 10, <span class="nv">func</span> <span class="o">=</span> <span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 11, <span class="nv">func</span> <span class="o">=</span> <span class="m">11</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 12, <span class="nv">func</span> <span class="o">=</span> <span class="m">12</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 13, <span class="nv">func</span> <span class="o">=</span> <span class="m">13</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 14, <span class="nv">func</span> <span class="o">=</span> <span class="m">14</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 15, <span class="nv">func</span> <span class="o">=</span> <span class="m">15</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 16, <span class="nv">func</span> <span class="o">=</span> <span class="m">16</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 17, <span class="nv">func</span> <span class="o">=</span> <span class="m">17</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 18, <span class="nv">func</span> <span class="o">=</span> <span class="m">18</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 19, <span class="nv">func</span> <span class="o">=</span> <span class="m">19</span>
</span></span><span class="line"><span class="cl"><span class="nv">j</span> <span class="o">=</span> 20, <span class="nv">func</span> <span class="o">=</span> <span class="m">20</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>æ‰§è¡Œç»“æœåˆ†æ</p>
<ul>
<li>å˜é‡i å’Œ state éƒ½æ˜¯ staticç±»å‹çš„ï¼Œæ˜¯æ–‡ä»¶å…¨å±€ä½œç”¨åŸŸçš„</li>
<li>é¦–æ¬¡æ‰§è¡Œfunctionå‡½æ•°æ—¶ï¼Œstate = 0ï¼Œgoto åˆ° LABEL0ï¼Œç„¶åè¿›è¡Œæ­£å¸¸å¾ªç¯å’Œè¿”å›</li>
<li>å½“functionè°ƒç”¨æ¬¡æ•°è¶…è¿‡åæ¬¡åï¼Œæ¯æ¬¡è¿›å…¥functionå‡½æ•°å†…éƒ¨æ—¶ï¼Œç”±switchåˆ†å‘åˆ°LABEL1ï¼›æ‰§è¡Œå®Œå¾ªç¯ä½“åï¼Œå¯¹iå¢1ï¼Œç„¶åè¿›è¡Œåˆ¤æ–­æ˜¯å¦ i &lt; 10ï¼Œå‘ç°ä¸æ»¡è¶³ï¼Œé€€å‡ºç¨‹åº</li>
<li>å¯èƒ½æˆ‘ä»¬ä¼šæ¯”è¾ƒçº ç»“functionç¨‹åºåœ¨ i &gt; 10åä¸å†æ‰§è¡Œreturn iè¯­å¥ï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šè¿”å›è‡ªå¢åçš„ç»“æœå‘¢ï¼Ÿ
<ul>
<li>ä»ä»£ç çš„æ±‡ç¼–ç»“æœæ¥çœ‹ï¼Œæ¯æ¬¡functionè¿”å›æ—¶ï¼Œiéƒ½åœ¨ä¹‹å‰èµ‹å€¼ç»™å¯„å­˜å™¨eaxäº†ï¼Œè€Œeaxå­˜å‚¨çš„æ˜¯å‡½æ•°çš„è¿”å›å€¼ï¼Œæ‰€ä»¥æ¯æ¬¡functionçš„è¿”å›ç»“æœæ˜¯iï¼Œå³ä½¿ä¸æ‰§è¡Œreturnè¯­å¥</li>
</ul>
</li>
<li>returnåœ¨è¿™é‡Œå¹¶ä¸æ˜¯è¿”å›çš„æ„æ€ï¼Œè€Œæ˜¯yieldçš„æ„æ€</li>
</ul>
</li>
<li>
<p>ä»ç„¶æœ‰ä¸¤ç§æ›´ä¼˜åŒ–çš„å†™æ³•: <a class="link" href="http://coolshell.cn/articles/10975.html"  target="_blank" rel="noopener"
    >å·¦è€³æœµè€—å­çš„ä¾‹å­</a>å’Œ<a class="link" href="http://www.hawkwithwind.net/blog/2011/02/18/%E5%8D%8F%E7%A8%8B%E7%9A%84c%E5%AE%9E%E7%8E%B0/"  target="_blank" rel="noopener"
    >ä¸Šä¾‹</a>çš„æ¥æºéƒ½æ˜¯å¤©æ‰ç¨‹åºå‘˜  <a class="link" href="http://www.chiark.greenend.org.uk/~sgtatham/"  target="_blank" rel="noopener"
    >imon Tatham</a>å¯¹<a class="link" href="http://www.chiark.greenend.org.uk/~sgtatham/coroutines.html"  target="_blank" rel="noopener"
    >åç¨‹åšçš„å°è¯•</a>ï¼Œä»¥åŠå…³äºswtich-caseå†™æ³•çš„duffæœºå™¨çš„<a class="link" href="http://bbs.chinaunix.net/thread-1833313-1-1.html"  target="_blank" rel="noopener"
    >è®¨è®º</a></p>
</li>
<li>
<p>ç†è§£<a class="link" href="http://www.colaghost.net/os/unix_linux/341"  target="_blank" rel="noopener"
    >åç¨‹å®ç°çš„åŸºç¡€</a>å°±æ˜¯ç¨‹åºä¸­çš„å‡½æ•°è°ƒç”¨å¯¼è‡´çš„<a class="link" href="http://blog.csdn.net/ylyuanlu/article/details/18947951"  target="_blank" rel="noopener"
    >æ ˆå¸§åˆ‡æ¢</a>ï¼Œåœ¨åˆ‡æ¢å‰å…ˆä¿å­˜è¢«åˆ‡æ¢subroutineçš„ä¸Šä¸‹æ–‡ï¼Œåœ¨åˆ‡æ¢æ—¶ç”¨æ–°subroutineæ›¿æ¢å½“å‰ç¨‹åºçš„æ‰§è¡ŒçŠ¶æ€ã€‚ä»¥Linuxä¸­ç”¨äºå®ç°åç¨‹çš„ä¸€ä¸ªapiï¼šucontextæ¥è¯´ï¼Œmakecontextå‡½æ•°å°†contextçš„eipè®¾ç½®ä¸ºfuncå‚æ•°çš„åœ°å€ï¼Œæ‰€ä»¥å½“è¯¥contextå¾—ä»¥æ‰§è¡Œæ—¶ï¼Œfuncå‡½æ•°å°±å¼€å§‹æ‰§è¡Œäº†ï¼›swapcontext(old, new)å°†å½“å‰ç¨‹åºå¤„äºçš„oldçŠ¶æ€åˆ‡æ¢åˆ°newçŠ¶æ€ï¼Œç„¶ånewçŠ¶æ€çš„funcå°±å¾—ä»¥æ‰§è¡Œã€‚</p>
</li>
<li>
<p>Linuxå¯¹äºåç¨‹å®ç°æä¾›äº†setjmp/longjmpå’Œucontextä¸¤ç§æœºåˆ¶ï¼Œç°æœ‰çš„åç¨‹åº“ï¼Œæ¯”å¦‚<a class="link" href="http://dunkels.com/adam/pt/"  target="_blank" rel="noopener"
    >protothread</a>ï¼Œç”šè‡³æ˜¯LuaVMä¸­çš„åç¨‹å®ç°ï¼Œä¹Ÿä¼šåŸºäºè¿™ä¸¤ç§æœºåˆ¶ä¹‹ä¸€æ¥å®ç°ã€‚å½“ç„¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ‡æ¢cpuçš„æ‰€æœ‰å¯„å­˜å™¨çŠ¶æ€ï¼Œä»¥å®ç°åç¨‹ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯æ˜¯æä¸æ¨èçš„ã€‚</p>
</li>
</ul>
<h2 id="setjump--longjmp">setjump &amp; longjmp</h2>
<h5 id="man-longjmp">man longjmp</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME
</span></span><span class="line"><span class="cl">       longjmp, siglongjmp - nonlocal jump to a saved stack context
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SYNOPSIS
</span></span><span class="line"><span class="cl">       <span class="c1">#include &lt;setjmp.h&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       void longjmp<span class="o">(</span>jmp_buf env, int val<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       void siglongjmp<span class="o">(</span>sigjmp_buf env, int val<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DESCRIPTION
</span></span><span class="line"><span class="cl">       longjmp<span class="o">()</span>  and  setjmp<span class="o">(</span>3<span class="o">)</span> are useful <span class="k">for</span> dealing with errors and interrupts encountered in a low-level subroutine of a program. 
</span></span><span class="line"><span class="cl">	   
</span></span><span class="line"><span class="cl">       longjmpå’Œsetjmpåœ¨å¤„ç†ç¨‹åºè°ƒç”¨å­ä¾‹ç¨‹è¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯æˆ–ä¸­æ–­æ—¶éå¸¸æœ‰ç”¨ã€‚
</span></span><span class="line"><span class="cl">	   
</span></span><span class="line"><span class="cl">       longjmp<span class="o">()</span> restores the environment saved by the last call of setjmp<span class="o">(</span>3<span class="o">)</span> with the corresponding env argument.  After longjmp<span class="o">()</span> is completed, program execution continues as <span class="k">if</span> the corresponding call of setjmp<span class="o">(</span>3<span class="o">)</span> had just returned the value val.  longjmp<span class="o">()</span> cannot cause <span class="m">0</span> to be returned.  If longjmp<span class="o">()</span> is invoked with a second argument of 0, <span class="m">1</span> will be returned instead.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       longjmpå°†æ¢å¤æœ€è¿‘ä¸€æ¬¡è°ƒç”¨setjmpæ—¶é€šè¿‡envå‚æ•°ä¿å­˜çš„ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚longjmpå®Œæˆåï¼ŒåŸæ¥è°ƒç”¨setjmpçš„åœ°æ–¹å°†ä¼šè¿”å›ï¼Œå¹¶ä¸”setjmpçš„è¿”å›å€¼æ˜¯longjmpçš„valå‚æ•°ã€‚longjmpä¸ä¼šè¿”å›0ã€‚å¦‚æœlongjmpè°ƒç”¨æ—¶ç¬¬äºŒä¸ªå‚æ•°æ˜¯0ï¼Œé‚£ä¹ˆå®ƒå°†ä¼šè¿”å›1.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       siglongjmp<span class="o">()</span>  is  similar  to longjmp<span class="o">()</span> except <span class="k">for</span> the <span class="nb">type</span> of its env argument.  If, and only <span class="k">if</span>, the sigsetjmp<span class="o">(</span>3<span class="o">)</span> call that <span class="nb">set</span> this env used a nonzero savesigs flag, siglongjmp<span class="o">()</span> also restores the signal mask that was saved by sigsetjmp<span class="o">(</span>3<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">RETURN VALUE
</span></span><span class="line"><span class="cl">       These functions never <span class="k">return</span>.
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="man-setjmp">man setjmp</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME
</span></span><span class="line"><span class="cl">       setjmp, sigsetjmp - save stack context <span class="k">for</span> nonlocal goto
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SYNOPSIS
</span></span><span class="line"><span class="cl">       <span class="c1">#include &lt;setjmp.h&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       int setjmp<span class="o">(</span>jmp_buf env<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       int sigsetjmp<span class="o">(</span>sigjmp_buf env, int savesigs<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	 
</span></span><span class="line"><span class="cl">DESCRIPTION
</span></span><span class="line"><span class="cl">       setjmp<span class="o">()</span>  and  longjmp<span class="o">(</span>3<span class="o">)</span>  are  useful <span class="k">for</span> dealing with errors and interrupts encountered in a low-level subroutine of a program.  
</span></span><span class="line"><span class="cl">	   
</span></span><span class="line"><span class="cl">       setjmp<span class="o">()</span> saves the stack context/environment in env <span class="k">for</span> later use by longjmp<span class="o">(</span>3<span class="o">)</span>.  The stack context will be invalidated <span class="k">if</span> the <span class="k">function</span> which called setjmp<span class="o">()</span> returns.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	   setjmp<span class="o">()</span> åœ¨å‚æ•°envä¸­ä¿å­˜æ ˆå¸§ï¼Œç¨ålongjmpè°ƒç”¨æ—¶ï¼Œå°†ä»setjmpæ‰§è¡Œï¼›
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       sigsetjmp<span class="o">()</span> is similar to setjmp<span class="o">()</span>.  If, and only <span class="k">if</span>, savesigs is nonzero, the process<span class="err">&#39;</span>s current signal mask is saved in env and will be restored <span class="k">if</span> a siglongjmp<span class="o">(</span>3<span class="o">)</span> is later performed with this env.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">RETURN VALUE
</span></span><span class="line"><span class="cl">       setjmp<span class="o">()</span> and sigsetjmp<span class="o">()</span> <span class="k">return</span> <span class="m">0</span> <span class="k">if</span> returning directly, and nonzero when returning from longjmp<span class="o">(</span>3<span class="o">)</span> or siglongjmp<span class="o">(</span>3<span class="o">)</span> using the saved context.
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ç¤ºä¾‹ä»£ç ">ç¤ºä¾‹ä»£ç </h5>
<p><a class="link" href="http://blog.linux.org.tw/~jserv/archives/001848.html"  target="_blank" rel="noopener"
    >ä»£ç åœ°å€</a> åšå®¢è¯„è®ºåŒº</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;                                                                                  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;setjmp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">jmp_buf</span> <span class="n">jmpbuf_th0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">jmp_buf</span> <span class="n">jmpbuf_th1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">cnt1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">cnt0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">thread_0</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s </span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">longjmp</span><span class="p">(</span><span class="n">jmpbuf_th0</span><span class="p">,</span> <span class="n">cnt0</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">thread_1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s </span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">longjmp</span><span class="p">(</span><span class="n">jmpbuf_th1</span><span class="p">,</span> <span class="n">cnt1</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">rc0</span><span class="p">,</span> <span class="n">rc1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">entry_thread_0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">rc0</span> <span class="o">=</span> <span class="n">setjmp</span><span class="p">(</span><span class="n">jmpbuf_th0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;rc0 = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">rc0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">rc0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">thread_1</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nl">entry_thread_1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">rc1</span> <span class="o">=</span> <span class="n">setjmp</span><span class="p">(</span><span class="n">jmpbuf_th1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;rc1 = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">rc1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">thread_0</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰§è¡Œç»“æœ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">rc0</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">rc1</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">thread_0 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">rc0</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">thread_1 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">rc1</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">thread_0 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">rc0</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">thread_1 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">rc1</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">thread_0 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">rc0</span> <span class="o">=</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">thread_1 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">rc1</span> <span class="o">=</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">thread_0 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">rc0</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">thread_1 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">rc1</span> <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">thread_0 
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>æ‰§è¡Œè¿‡ç¨‹åˆ†æ</p>
<ul>
<li>setjmpå’Œlongjmpéƒ½æ˜¯åŸºäºç¨‹åºç©ºé—´ä¸­é¢å¤–çš„jmpbuf</li>
<li>setjmpå°†å½“å‰ç¯å¢ƒå­˜å‚¨åœ¨jmpbufä¸­ï¼Œlongjmpåˆ°åŒä¸€ä¸ªjmpbufæ—¶ï¼Œsetjmpå°†ä¼šå†æ¬¡è¿”å›ï¼Œè¿”å›å€¼æ˜¯longjmpçš„ç¬¬äºŒä¸ªå‚æ•°val</li>
<li>å¦‚æœsetjmpä¸æ˜¯å› ä¸ºlongjmpè¿”å›çš„ï¼Œè¿”å›å€¼ä¸º0</li>
<li>ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ‰§è¡Œç»“æœä¸­ï¼Œè‡ªå¢çš„cnt0å’Œcnt1åœ¨å€¼ä¸º1çš„æ—¶å€™åœé¡¿äº†ä¸€æ¬¡ï¼Ÿ</li>
</ul>
</li>
<li>
<p><a class="link" href="https://github.com/nasrallahmounir/context-switch-setjmp-longjm"  target="_blank" rel="noopener"
    >setjump &amp; longjmp è¿›é˜¶å®ç°</a></p>
</li>
<li>
<p><a class="link" href="https://github.com/mrquincle/event-abbey"  target="_blank" rel="noopener"
    >setjump &amp; longjmp è¿›é˜¶å®ç°</a></p>
</li>
</ul>
<h2 id="ucontext">ucontext</h2>
<h5 id="man-getcontext">man getcontext</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">In  a  System  V-like  environment,  one has the two types mcontext_t and ucontext_t defined in &lt;ucontext.h&gt; and the four functions getcontext<span class="o">()</span>, setcontext<span class="o">()</span>, makecontext<span class="o">(</span>3<span class="o">)</span>, and swapcontext<span class="o">(</span>3<span class="o">)</span> that
</span></span><span class="line"><span class="cl">allow user-level context switching between multiple threads of control within a process.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The mcontext_t <span class="nb">type</span> is machine-dependent and opaque.  The ucontext_t <span class="nb">type</span> is a structure that has at least the following fields:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    typedef struct ucontext <span class="o">{</span>
</span></span><span class="line"><span class="cl">        struct ucontext *uc_link<span class="p">;</span>
</span></span><span class="line"><span class="cl">        sigset_t         uc_sigmask<span class="p">;</span>
</span></span><span class="line"><span class="cl">        stack_t          uc_stack<span class="p">;</span>
</span></span><span class="line"><span class="cl">        mcontext_t       uc_mcontext<span class="p">;</span>
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">    <span class="o">}</span> ucontext_t<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">with sigset_t and stack_t defined in &lt;signal.h&gt;.  Here uc_link points to the context that will be resumed when the current context terminates <span class="o">(</span>in <span class="k">case</span> the current context was created  using  makeconâ€
</span></span><span class="line"><span class="cl">text<span class="o">(</span>3<span class="o">))</span>,  uc_sigmask is the <span class="nb">set</span> of signals blocked in this context <span class="o">(</span>see sigprocmask<span class="o">(</span>2<span class="o">))</span>, uc_stack is the stack used by this context <span class="o">(</span>see sigaltstack<span class="o">(</span>2<span class="o">))</span>, and uc_mcontext is the machine-specific repâ€
</span></span><span class="line"><span class="cl">resentation of the saved context, that includes the calling thread<span class="err">&#39;</span>s machine registers.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The <span class="k">function</span> getcontext<span class="o">()</span> initializes the structure pointed at by ucp to the currently active context.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The <span class="k">function</span> setcontext<span class="o">()</span> restores the user context pointed at by ucp.  A successful call does not <span class="k">return</span>.  The context should have been obtained by a call  of  getcontext<span class="o">()</span>,  or  makecontext<span class="o">(</span>3<span class="o">)</span>,  or
</span></span><span class="line"><span class="cl">passed as third argument to a signal handler.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">If the context was obtained by a call of getcontext<span class="o">()</span>, program execution continues as <span class="k">if</span> this call just returned.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">If the context was obtained by a call of makecontext<span class="o">(</span>3<span class="o">)</span>, program execution continues by a call to the <span class="k">function</span> func specified as the second argument of that call to makecontext<span class="o">(</span>3<span class="o">)</span>.  When the <span class="k">function</span>
</span></span><span class="line"><span class="cl">func returns, we <span class="k">continue</span> with the uc_link member of the structure ucp specified as the first argument of that call to makecontext<span class="o">(</span>3<span class="o">)</span>.  When this member is NULL, the thread exits.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">If the context was obtained by a call to a signal handler, <span class="k">then</span> old standard text says that <span class="s2">&#34;program execution continues with the program instruction following the instruction interrupted by the sigâ€
</span></span></span><span class="line"><span class="cl"><span class="s2">nal&#34;</span>.  However, this sentence was removed in SUSv2, and the present verdict is <span class="s2">&#34;the result is unspecified&#34;</span>.
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="man-makecontext">man makecontext</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">In  a  System  V-like  environment,  one has the <span class="nb">type</span> ucontext_t defined in &lt;ucontext.h&gt; and the four functions getcontext<span class="o">(</span>3<span class="o">)</span>, setcontext<span class="o">(</span>3<span class="o">)</span>, makecontext<span class="o">()</span> and swapcontext<span class="o">()</span> that allow user-level context switching between multiple threads of control within a
</span></span><span class="line"><span class="cl">process.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">åœ¨ç±»System Vç¯å¢ƒä¸‹ï¼Œç»“æ„ä½“ucontext_tå’Œå››ä¸ªå‡½æ•° getcontextã€setcontextã€makecontextå’Œswapcontextæä¾›äº†åœ¨ä¸€ä¸ªè¿›ç¨‹å†…é€šè¿‡ç”¨æˆ·çº§ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ–¹å¼å®ç°å¤šçº¿ç¨‹çš„æ–¹å¼
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">For the <span class="nb">type</span> and the first two functions, see getcontext<span class="o">(</span>3<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The makecontext<span class="o">()</span> <span class="k">function</span> modifies the context pointed to by ucp <span class="o">(</span>which was obtained from a call to getcontext<span class="o">(</span>3<span class="o">))</span>.  Before invoking makecontext<span class="o">()</span>, the <span class="nb">caller</span> must allocate a new stack <span class="k">for</span> this context and assign its address to ucp-&gt;uc_stack, and  define  a
</span></span><span class="line"><span class="cl">successor context and assign its address to ucp-&gt;uc_link.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">makecontextå‡½æ•°å°†ä¿®æ”¹ucpæŒ‡å‘çš„ ucontext_tï¼ˆå¿…é¡»æ˜¯ä»getcontextè·å¾—çš„å¯¹è±¡ï¼‰ï¼Œåœ¨è°ƒç”¨makecontextå‰ï¼Œè°ƒç”¨è€…å¿…é¡»ä¸ºæ”¹ä¸Šä¸‹æ–‡åˆ†é…ä¸€ä¸ªæ–°çš„æ ˆï¼Œå¹¶å°†ucp-&gt;uc_stackæŒ‡å‘æ ˆçš„åœ°å€ï¼ŒåŒæ—¶å°†ucp-&gt;uc_linkæŒ‡å‘ä¸‹ä¸€ä¸ªcontext
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">When  this  context  is  later activated <span class="o">(</span>using setcontext<span class="o">(</span>3<span class="o">)</span> or swapcontext<span class="o">())</span> the <span class="k">function</span> func is called, and passed the series of integer <span class="o">(</span>int<span class="o">)</span> arguments that follow argc<span class="p">;</span> the <span class="nb">caller</span> must specify the number of these arguments in argc.  When this <span class="k">function</span>
</span></span><span class="line"><span class="cl">returns, the successor context is activated.  If the successor context pointer is NULL, the thread exits.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">å½“è¯¥contextç¨åè¢«æ¿€æ´»<span class="o">(</span>é€šè¿‡setcontextæˆ–è€…swapcontext<span class="o">)</span>ï¼Œmakecontextå‡½æ•°å‚æ•°ä¸­çš„funcå°†è¢«è°ƒç”¨ï¼ŒåŒæ—¶å‘funcä¼ é€’argcä¸ªå‚æ•°ã€‚å½“funcè¿”å›æ—¶ï¼Œä¸‹ä¸€ä¸ªcontextå°†è¢«æ¿€æ´»è°ƒç”¨ã€‚å¦‚æœä¸‹ä¸€ä¸ªcontextæ˜¯nullçš„è¯ï¼Œè¯¥çº¿ç¨‹ç»“æŸã€‚
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The swapcontext<span class="o">()</span> <span class="k">function</span> saves the current context in the structure pointed to by oucp, and <span class="k">then</span> activates the context pointed to by ucp.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">swapcontextå‡½æ•°å°†å½“å‰contextä¿å­˜åœ¨oucpç»“æ„ä½“ï¼ŒåŒæ—¶æ¿€æ´»ucpæŒ‡å‘çš„contextã€‚
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="man-page-ä¸­çš„ä¾‹å­">man page ä¸­çš„ä¾‹å­</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#include &lt;ucontext.h&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;stdio.h&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#include &lt;stdlib.h&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static ucontext_t uctx_main, uctx_func1, uctx_func2<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#define handle_error(msg) \</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="o">{</span> perror<span class="o">(</span>msg<span class="o">)</span><span class="p">;</span> exit<span class="o">(</span>EXIT_FAILURE<span class="o">)</span><span class="p">;</span> <span class="o">}</span> <span class="k">while</span> <span class="o">(</span>0<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static void
</span></span><span class="line"><span class="cl">func1<span class="o">(</span>void<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    printf<span class="o">(</span><span class="s2">&#34;func1: started\n&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    printf<span class="o">(</span><span class="s2">&#34;func1: swapcontext(&amp;uctx_func1, &amp;uctx_func2)\n&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span>swapcontext<span class="o">(</span><span class="p">&amp;</span>uctx_func1, <span class="p">&amp;</span>uctx_func2<span class="o">)</span> <span class="o">==</span> -1<span class="o">)</span>
</span></span><span class="line"><span class="cl">        handle_error<span class="o">(</span><span class="s2">&#34;swapcontext&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    printf<span class="o">(</span><span class="s2">&#34;func1: returning\n&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">static void
</span></span><span class="line"><span class="cl">func2<span class="o">(</span>void<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    printf<span class="o">(</span><span class="s2">&#34;func2: started\n&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    printf<span class="o">(</span><span class="s2">&#34;func2: swapcontext(&amp;uctx_func2, &amp;uctx_func1)\n&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span>swapcontext<span class="o">(</span><span class="p">&amp;</span>uctx_func2, <span class="p">&amp;</span>uctx_func1<span class="o">)</span> <span class="o">==</span> -1<span class="o">)</span>
</span></span><span class="line"><span class="cl">        handle_error<span class="o">(</span><span class="s2">&#34;swapcontext&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    printf<span class="o">(</span><span class="s2">&#34;func2: returning\n&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">int
</span></span><span class="line"><span class="cl">main<span class="o">(</span>int argc, char *argv<span class="o">[])</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    char func1_stack<span class="o">[</span>16384<span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    char func2_stack<span class="o">[</span>16384<span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span>getcontext<span class="o">(</span><span class="p">&amp;</span>uctx_func1<span class="o">)</span> <span class="o">==</span> -1<span class="o">)</span>
</span></span><span class="line"><span class="cl">        handle_error<span class="o">(</span><span class="s2">&#34;getcontext&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    uctx_func1.uc_stack.ss_sp <span class="o">=</span> func1_stack<span class="p">;</span>
</span></span><span class="line"><span class="cl">    uctx_func1.uc_stack.ss_size <span class="o">=</span> sizeof<span class="o">(</span>func1_stack<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    uctx_func1.uc_link <span class="o">=</span> <span class="p">&amp;</span>uctx_main<span class="p">;</span>
</span></span><span class="line"><span class="cl">    makecontext<span class="o">(</span><span class="p">&amp;</span>uctx_func1, func1, 0<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span>getcontext<span class="o">(</span><span class="p">&amp;</span>uctx_func2<span class="o">)</span> <span class="o">==</span> -1<span class="o">)</span>
</span></span><span class="line"><span class="cl">        handle_error<span class="o">(</span><span class="s2">&#34;getcontext&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    uctx_func2.uc_stack.ss_sp <span class="o">=</span> func2_stack<span class="p">;</span>
</span></span><span class="line"><span class="cl">    uctx_func2.uc_stack.ss_size <span class="o">=</span> sizeof<span class="o">(</span>func2_stack<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    /* Successor context is f1<span class="o">()</span>, unless argc &gt; <span class="m">1</span> */
</span></span><span class="line"><span class="cl">    uctx_func2.uc_link <span class="o">=</span> <span class="o">(</span>argc &gt; 1<span class="o">)</span> ? NULL : <span class="p">&amp;</span>uctx_func1<span class="p">;</span>
</span></span><span class="line"><span class="cl">    makecontext<span class="o">(</span><span class="p">&amp;</span>uctx_func2, func2, 0<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    printf<span class="o">(</span><span class="s2">&#34;main: swapcontext(&amp;uctx_main, &amp;uctx_func2)\n&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span>swapcontext<span class="o">(</span><span class="p">&amp;</span>uctx_main, <span class="p">&amp;</span>uctx_func2<span class="o">)</span> <span class="o">==</span> -1<span class="o">)</span>
</span></span><span class="line"><span class="cl">        handle_error<span class="o">(</span><span class="s2">&#34;swapcontext&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    printf<span class="o">(</span><span class="s2">&#34;main: exiting\n&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    exit<span class="o">(</span>EXIT_SUCCESS<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// http://stackoverflow.com/questions/20778735/is-the-type-stack-t-no-longer-defined-on-linux
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰§è¡Œç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ gcc context.c -o context.o
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ./context.o 
</span></span><span class="line"><span class="cl">main: swapcontext<span class="o">(</span><span class="p">&amp;</span>uctx_main, <span class="p">&amp;</span>uctx_func2<span class="o">)</span>
</span></span><span class="line"><span class="cl">func2: started
</span></span><span class="line"><span class="cl">func2: swapcontext<span class="o">(</span><span class="p">&amp;</span>uctx_func2, <span class="p">&amp;</span>uctx_func1<span class="o">)</span>
</span></span><span class="line"><span class="cl">func1: started
</span></span><span class="line"><span class="cl">func1: swapcontext<span class="o">(</span><span class="p">&amp;</span>uctx_func1, <span class="p">&amp;</span>uctx_func2<span class="o">)</span>
</span></span><span class="line"><span class="cl">func2: returning
</span></span><span class="line"><span class="cl">func1: returning
</span></span><span class="line"><span class="cl">main: exiting
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡manpageä¸­æä¾›çš„ucontext_tæºç ï¼Œç»“åˆman pageä¸­çš„è§£é‡Šï¼Œæˆ‘ä»¬å¯¹æ­¤åšä¸€åˆ†æã€‚</p>
<ul>
<li>æ‰§è¡Œè¿‡ç¨‹è¯¦è§£
<ul>
<li>getcontext(&amp;uctx_func2) ç”¨å½“å‰ä¸Šä¸‹æ–‡åˆå§‹åŒ–ucontext_tç»“æ„ä½“å¯¹è±¡ï¼šuctx_func2</li>
<li>åœ¨è°ƒç”¨makecontextå‰ï¼Œè°ƒç”¨è€…ä¸ºè¯¥ä¸Šä¸‹æ–‡åˆ†é…ä¸€ä¸ªæ–°çš„æ ˆï¼Œå¹¶å°†æˆå‘˜uc_stackæŒ‡å‘æ ˆçš„åœ°å€ï¼ŒåŒæ—¶å°†uc_linkæŒ‡å‘ä¸‹ä¸€ä¸ªcontextã€‚æ­¤æ—¶argcä¸º0ï¼Œæ‰€ä»¥uctx_func2çš„uc_linkæŒ‡å‘uctx_func1ï¼Œä¹Ÿå°±æ˜¯è¯´å½“uctx_func2æ‰§è¡Œå®Œåï¼Œä¼šè‡ªåŠ¨æ¿€æ´»uctx_func1æ‰§è¡Œ</li>
<li>makecontext(&amp;uctx_func2, func2, 0) å‡½æ•°è®¾ç½®å½“uctx_func2æ¿€æ´»æ—¶ï¼Œè°ƒç”¨func2å‡½æ•°ï¼Œå‚æ•°ä¸º0ä¸ªï¼›å½“func2è¿”å›æ—¶ï¼Œä¸‹ä¸€ä¸ªcontextå°†è¢«æ¿€æ´»ï¼Œåœ¨è¿™é‡Œæ˜¯uctx_func1</li>
<li>swapcontext(&amp;uctx_main, &amp;uctx_func2) å‡½æ•°å°†è¿›ç¨‹å½“å‰æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ä¿å­˜åœ¨uctx_mainä¸­ï¼Œå¹¶æ¿€æ´»uctx_func2ï¼›uctx_func2å¼€å§‹æ‰§è¡Œï¼Œé¦–å…ˆè¢«æ‰§è¡Œçš„æ˜¯func2å‡½æ•°ï¼Œ
<ul>
<li>func2: started</li>
<li>func2: swapcontext(&amp;uctx_func2, &amp;uctx_func1)</li>
</ul>
</li>
<li>éšåfunc2å‡½æ•°è°ƒç”¨ swapcontext(&amp;uctx_func2, &amp;uctx_func1)ï¼Œå°†å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¿å­˜åœ¨uctx_func2ä¸­ï¼Œæ¿€æ´»uctx_func1ï¼›uctx_func1å¼€å§‹æ‰§è¡Œï¼Œé¦–å…ˆæ‰§è¡Œçš„æ˜¯func1ï¼Œæ‰“å°å‡ºï¼š
<ul>
<li>func1: started</li>
<li>func1: swapcontext(&amp;uctx_func1, &amp;uctx_func2)</li>
</ul>
</li>
<li>éšåfunc1å‡½æ•°è°ƒç”¨swapcontext(&amp;uctx_func1, &amp;uctx_func2)ï¼Œå°†å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¿å­˜åœ¨uctx_func1ä¸­ï¼Œå¹¶æ¿€æ´»uctx_func2ï¼›ä¸Šä¸€æ¬¡uctx_func2ä¿å­˜çš„ä¸Šä¸‹æ–‡ç¯å¢ƒå°†è¢«å›å¤ï¼Œç„¶åè¿›ç¨‹æ‰§è¡Œè¿”å›åˆ°ä¸Šæ¬¡è¢«swap_contextçš„ç‚¹ï¼Œæ‰“å°å‡º:
<ul>
<li>func2: returning</li>
</ul>
</li>
<li>func2å‡½æ•°è¿”å›åï¼Œuctx_func2ä¹Ÿå°±è¿”å›äº†ï¼Œä¸‹ä¸€ä¸ªcontextå°†è¢«æ¿€æ´»ï¼Œä¹Ÿå°±æ˜¯uctx_func1ï¼›æ‰“å°å‡ºï¼š
<ul>
<li>func1: returning</li>
</ul>
</li>
<li>uctx_func1ä¹Ÿæ‰§è¡Œç»“æŸï¼Œè€Œå®ƒçš„ä¸‹ä¸€ä¸ªcontextæ˜¯uctx_mainï¼Œåœ¨mainå‡½æ•°ä¸­æœ€å¼€å§‹è°ƒç”¨swap_context(&amp;uctx_main, &amp;uctx_func2)æ—¶ï¼Œå½“æ—¶ç¨‹åºæ‰§è¡Œçš„ä¸Šä¸‹æ–‡çš„åœ°å€å°±æ˜¯è¿™å¥ï¼Œé‚£ä¹ˆåœ¨mainä¸­ç»§ç»­æ‰§è¡Œï¼Œæ‰“å°å‡ºï¼š
<ul>
<li>main: exiting</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./context.o x
</span></span><span class="line"><span class="cl">main: swapcontext<span class="o">(</span><span class="p">&amp;</span>uctx_main, <span class="p">&amp;</span>uctx_func2<span class="o">)</span>
</span></span><span class="line"><span class="cl">func2: started
</span></span><span class="line"><span class="cl">func2: swapcontext<span class="o">(</span><span class="p">&amp;</span>uctx_func2, <span class="p">&amp;</span>uctx_func1<span class="o">)</span>
</span></span><span class="line"><span class="cl">func1: started
</span></span><span class="line"><span class="cl">func1: swapcontext<span class="o">(</span><span class="p">&amp;</span>uctx_func1, <span class="p">&amp;</span>uctx_func2<span class="o">)</span>
</span></span><span class="line"><span class="cl">func2: returning
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>æ‰§è¡Œè¿‡ç¨‹è¯¦è§£
<ul>
<li>å½“argcä¸ªæ•°ä¸ä¸º0æ—¶ï¼Œuctx_func2çš„uc_linkä¸ºNULLï¼Œæ‰€ä»¥å¦‚æœuctx_func2ç»“æŸç”Ÿå‘½å‘¨æœŸï¼Œé‚£ä¹ˆæ•´ä¸ªè¿›ç¨‹å°†ä¼šé€€å‡º</li>
<li>åœ¨ç¬¬ä¸€æ¬¡swap_context(&amp;uctx_main, &amp;uctx_func2)æ—¶å¼€å§‹è°ƒç”¨func2ï¼Œfunc2ä¸­æ‰“å°å‡ºï¼š
<ul>
<li>func2: started</li>
<li>func2: swapcontext(&amp;uctx_func2, &amp;uctx_func1)</li>
</ul>
</li>
<li>éšåswapæ‰§è¡Œuctx_func1ï¼Œæ‰“å°ï¼š
<ul>
<li>func1: started</li>
<li>func1: swapcontext(&amp;uctx_func1, &amp;uctx_func2)</li>
</ul>
</li>
<li>éšåswapè¿”å›uctx_func2ï¼Œæ‰“å°ï¼š
<ul>
<li>func2: returning</li>
</ul>
</li>
<li>è€Œfunc2è¿”å›æ—¶ï¼Œç”±äºuctx_func2-&gt;uc_linkä¸ºNULLï¼Œæ‰€ä»¥æ•´ä¸ªè¿›ç¨‹é€€å‡ºï¼Œå¹¶ä¸ä¼šè¿”å›åˆ°ä¹‹å‰ä¿å­˜è¿‡çš„uctx_mainæ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ã€‚</li>
</ul>
</li>
</ul>
<p>é€šè¿‡ä»¥ä¸Šåˆ†æï¼Œæ‚¨æœ‰æ²¡æœ‰å¯¹åç¨‹æœ‰ä¸€ä¸ªç›´è§‚çš„è®¤è¯†å‘¢ï¼Ÿæœ¬è´¨ä¸Šï¼Œåç¨‹è°ƒåº¦åªæ˜¯å°†å½“å‰æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ä¿å­˜èµ·æ¥ï¼›è°ƒåº¦åç¨‹çš„æ—¶å€™å°±æ˜¯å°†ä¸¤ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡contextåˆ‡æ¢ï¼›æŒ‡å®šcontextçš„ä¸‹ä¸€ä¸ªcontextï¼Œåœ¨æœ¬contextæ‰§è¡Œç»“æŸåè‡ªåŠ¨æ¿€æ´»ä¸‹ä¸€ä¸ªcontextï¼Œå®ç°åä½œï¼›æœ¬contextæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œé€šè¿‡swap_contextä¸»åŠ¨è®©å‡ºCPUï¼Œè€Œä¸æ˜¯è¢«æŠ¢å æ”¾å¼ƒCPUã€‚</p>
<ul>
<li>å¯ä»¥å‚è€ƒä¸‹<a class="link" href="http://courses.cs.vt.edu/~cs3214/spring2016/examples/threads/coroutines.c"  target="_blank" rel="noopener"
    >è¿›ä¸€æ­¥çš„å®ç°</a>ï¼ŒåŠ æ·±ä¸‹å°è±¡ï¼š</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;ucontext.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">char</span> <span class="n">stack</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">65536</span><span class="p">];</span>            <span class="c1">// a stack for each coroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="n">ucontext_t</span> <span class="n">coroutine_state</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>   <span class="c1">// container to remember context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// switch current coroutine (0 -&gt; 1 -&gt; 0 -&gt; 1 ...)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">yield_to_next</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">int</span> <span class="n">current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">current</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">current</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">swapcontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coroutine_state</span><span class="p">[</span><span class="n">prev</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">coroutine_state</span><span class="p">[</span><span class="n">next</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">coroutine</span><span class="p">(</span><span class="kt">int</span> <span class="n">coroutine_number</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Coroutine %d counts i=%d (&amp;i=%p)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">coroutine_number</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">yield_to_next</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ucontext_t</span> <span class="n">return_to_main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// set up
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// initialize ucontext_t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">getcontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coroutine_state</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// set up per-context stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">coroutine_state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">uc_stack</span><span class="p">.</span><span class="n">ss_sp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">coroutine_state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">uc_stack</span><span class="p">.</span><span class="n">ss_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// when done, resume &#39;return_to_main&#39; context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">coroutine_state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">uc_link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">return_to_main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// let context[i] perform a call to coroutine(i) when swapped to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">makecontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coroutine_state</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="n">coroutine</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Starting coroutines...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">swapcontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">return_to_main</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">coroutine_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Done.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><a class="link" href="http://1234n.com/?post/aukxju"  target="_blank" rel="noopener"
    >another demo</a></p>
<ul>
<li><a class="link" href="http://1234n.com/?post/4vzsvm"  target="_blank" rel="noopener"
    >lib</a></li>
</ul>
</li>
<li>
<p><a class="link" href="https://www.gnu.org/software/pth/"  target="_blank" rel="noopener"
    >gnu portable threads</a></p>
<ul>
<li><a class="link" href="http://www.ossp.org/pkg/lib/pth/"  target="_blank" rel="noopener"
    >pt</a></li>
</ul>
</li>
<li>
<p><a class="link" href="https://swtch.com/libtask/"  target="_blank" rel="noopener"
    >libtask</a></p>
<ul>
<li><a class="link" href="http://www.cnblogs.com/foxmailed/p/3509359.html"  target="_blank" rel="noopener"
    >libtaskçš„coroutine</a></li>
</ul>
</li>
<li>
<p><a class="link" href="https://github.com/cloudwu/coroutine"  target="_blank" rel="noopener"
    >äº‘é£çš„å®ç°</a></p>
</li>
<li>
<p>å…¶ä»–ä¸€äº›åº”ç”¨</p>
<ul>
<li><a class="link" href="https://github.com/colaghost/coroutine_event"  target="_blank" rel="noopener"
    >coroutine-libevent</a>
<ul>
<li>åœ¨libeventé‡Œé€šè¿‡åç¨‹å®ç°åŒæ­¥</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="luaçš„åç¨‹">Luaçš„åç¨‹</h2>
<ul>
<li>
<p>luaä¸æ”¯æŒé‚£ç§çœŸæ­£çš„å¤šçº¿ç¨‹ï¼ˆå…±äº«åŒä¸€åœ°å€ç©ºé—´çš„æŠ¢å å¼çº¿ç¨‹ï¼‰ï¼ŒåŸå› æ˜¯</p>
<ul>
<li>ANSI Cæ²¡æœ‰åŸç”Ÿçš„å¤šçº¿ç¨‹ï¼Œæ‰€ä»¥luaä¸èƒ½ç›´æ¥è°ƒç”¨å®ç°</li>
<li>æœ€é‡è¦çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬ä¸è®¤ä¸ºå¤šçº¿ç¨‹åœ¨luaä¸­æ˜¯ä¸ªå¥½ä¸»æ„</li>
</ul>
</li>
<li>
<p>å¤šçº¿ç¨‹æ˜¯æä¾›ç»™åº•å±‚ç¼–ç¨‹çš„ã€‚å¤šçº¿ç¨‹çš„åŒæ­¥æœºåˆ¶ï¼Œæ¯”å¦‚ä¿¡å·é‡å’Œç›‘æ§éƒ½æ˜¯åœ¨æ“ä½œç³»ç»Ÿä¸Šä¸‹æ–‡å®ç°çš„ï¼Œè€Œéåº”ç”¨ç¨‹åºã€‚è°ƒè¯•å¤šçº¿ç¨‹æ¯”è¾ƒéº»çƒ¦ã€‚è€Œä¸”ï¼Œç”±äºç¨‹åºä¸´ç•ŒåŒºçš„åŒæ­¥å’Œç«äº‰ï¼Œå¤šçº¿ç¨‹ä¹Ÿä¼šå¼•èµ·æ€§èƒ½ä¸‹é™ã€‚</p>
</li>
<li>
<p>å¤šçº¿ç¨‹å¼•èµ·çš„é—®é¢˜ï¼Œä¸»è¦æ˜¯æŠ¢å å¼çº¿ç¨‹å’Œå…±äº«å†…å­˜å¯¼è‡´çš„ï¼Œluaè§£å†³è¿™ä¸¤ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯ï¼šlua coroutineæ˜¯åä½œå¼çš„ï¼ŒéæŠ¢å å¼çš„ï¼Œæ‰€ä»¥èƒ½é¿å…çº¿ç¨‹åˆ‡æ¢å¯¼è‡´çš„é—®é¢˜ï¼›lua coroutineä¹‹é—´ä¸å…±äº«å†…å­˜ã€‚</p>
</li>
<li>
<p>æˆ‘è§è¿‡çš„æœ€luaçš„<a class="link" href="https://techsingular.org/2012/12/22/programming-in-lua%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%8D-nil-%E5%92%8C-list/"  target="_blank" rel="noopener"
    >luaä»£ç å’Œåšå®¢</a></p>
</li>
<li>
<p>luaçš„<a class="link" href="https://techsingular.org/2013/05/09/programming-in-lua%EF%BC%88%E4%BA%94%EF%BC%89%EF%BC%8D-coroutine-lua-stack/"  target="_blank" rel="noopener"
    >coroutine and stack</a></p>
</li>
<li>
<p>luaçš„c runtime stackå’Œlua runtime stackæ˜¯<a class="link" href="https://techsingular.org/2013/07/14/programming-in-lua%EF%BC%88%E5%85%AD%EF%BC%89%EF%BC%8Dcontinuation/"  target="_blank" rel="noopener"
    >ä»€ä¹ˆæ ·å­çš„</a></p>
</li>
<li>
<p><a class="link" href="https://www.zhihu.com/question/21483863"  target="_blank" rel="noopener"
    >https://www.zhihu.com/question/21483863</a></p>
</li>
<li>
<p><a class="link" href="https://www.zhihu.com/question/30133749"  target="_blank" rel="noopener"
    >luaåç¨‹è°ƒåº¦</a></p>
<ul>
<li>luaå†…éƒ¨
<ul>
<li>å½“resumeçš„æ—¶å€™ï¼Œå°±åˆ‡æ¢lua_stateç¯å¢ƒï¼Œç„¶åsetjmpï¼Œç´§æ¥ç€ç”±äºpcæŒ‡å‘æ–°åœ°å€ï¼Œæ‰€ä»¥ä¼šç›´æ¥è·³è½¬åˆ°è¯¥ä½ç½®</li>
<li>å½“yieldæ—¶ï¼Œç›´æ¥å›å¤ç¯å¢ƒï¼Œç„¶ålongjmpåˆ°è¯¥resumeç‚¹</li>
</ul>
</li>
<li>lua with C
<ul>
<li>å½“åœ¨Cå‡½æ•°å†…å…¥yieldæ—¶ï¼Œä¼šæ¢å¤ç¯å¢ƒï¼Œlongjmpåˆ°resumeç‚¹ï¼Œä¹‹åå†æ¬¡resumeçš„æ—¶å€™ï¼Œä¼šå› ä¸ºç¯å¢ƒè¢«ç ´åï¼Œå¯¼è‡´resumeå‡ºé”™ï¼Œæ­¤æ—¶luaä¼šè°ƒç”¨kç³»åˆ—å‡½æ•°ï¼Œè®©resumeç»§ç»­ä¸‹å»</li>
</ul>
</li>
</ul>
</li>
<li>
<p><a class="link" href="http://www.ibm.com/developerworks/cn/opensource/os-cn-python-yield/"  target="_blank" rel="noopener"
    >luaå®ç°è°ƒåº¦å™¨</a></p>
</li>
<li>
<p><a class="link" href="https://www.lua.org/pil/9.2.html"  target="_blank" rel="noopener"
    >consumer-producer</a></p>
</li>
<li>
<p><a class="link" href="http://www.lua.org/manual/5.2/manual.html#2.6"  target="_blank" rel="noopener"
    >lua yield å’Œ resume</a></p>
<ul>
<li><a class="link" href="http://www.lua.org/manual/5.2/manual.html#pdf-coroutine.resume"  target="_blank" rel="noopener"
    >http://www.lua.org/manual/5.2/manual.html#pdf-coroutine.resume</a></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="c1">-- http://my.oschina.net/wangxuanyihaha/blog/186401</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">coroutine.yield</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">co</span> <span class="o">=</span> <span class="n">coroutine.create</span><span class="p">(</span><span class="kr">function</span> <span class="p">(</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;co-body&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">r</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;co-body&#34;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">coroutine.yield</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;co-body&#34;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">return</span> <span class="n">b</span><span class="p">,</span> <span class="s2">&#34;end&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="s2">&#34;main&#34;</span><span class="p">,</span> <span class="n">coroutine.resume</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="s2">&#34;main&#34;</span><span class="p">,</span> <span class="n">coroutine.resume</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="s2">&#34;m&#34;</span><span class="p">))</span>	<span class="c1">-- resumeçš„å‚æ•° &#39;m&#39; æ˜¯åœ¨è°ƒç”¨yieldä¼ å…¥çš„ï¼Œæ‰€ä»¥æœ¬æ¬¡æ˜¯åœ¨ç¬¬5è¡Œ return m</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="s2">&#34;main&#34;</span><span class="p">,</span> <span class="n">coroutine.resume</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="s2">&#34;x&#34;</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="s2">&#34;main&#34;</span><span class="p">,</span> <span class="n">coroutine.resume</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="s2">&#34;x&#34;</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">co-body	1	<span class="m">10</span>
</span></span><span class="line"><span class="cl">foo	<span class="m">2</span>
</span></span><span class="line"><span class="cl">main	<span class="nb">true</span>	<span class="m">4</span>
</span></span><span class="line"><span class="cl">co-body	m
</span></span><span class="line"><span class="cl">main	<span class="nb">true</span>	11	-9
</span></span><span class="line"><span class="cl">co-body	x	y
</span></span><span class="line"><span class="cl">main	<span class="nb">true</span>	10	end
</span></span><span class="line"><span class="cl">main	<span class="nb">false</span>	cannot resume dead coroutine
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="pythonçš„åç¨‹å¾…ç»­">pythonçš„åç¨‹(å¾…ç»­)</h2>
<ul>
<li><a class="link" href="http://www.ibm.com/developerworks/cn/opensource/os-cn-python-yield/"  target="_blank" rel="noopener"
    >http://www.ibm.com/developerworks/cn/opensource/os-cn-python-yield/</a>
<ul>
<li>ç®€å•åœ°è®²ï¼Œyield çš„ä½œç”¨å°±æ˜¯æŠŠä¸€ä¸ªå‡½æ•°å˜æˆä¸€ä¸ª generatorï¼Œå¸¦æœ‰ yield çš„å‡½æ•°ä¸å†æ˜¯ä¸€ä¸ªæ™®é€šå‡½æ•°ï¼ŒPython è§£é‡Šå™¨ä¼šå°†å…¶è§†ä¸ºä¸€ä¸ª generator</li>
<li>äº§ç”Ÿä¸€ä¸ªiterableå¯¹è±¡</li>
</ul>
</li>
</ul>
<h2 id="golangçš„åç¨‹å¾…ç»­">golangçš„åç¨‹(å¾…ç»­)</h2>
<ul>
<li><a class="link" href="http://stackoverflow.com/questions/13107958/what-exactly-does-runtime-gosched-do"  target="_blank" rel="noopener"
    >http://stackoverflow.com/questions/13107958/what-exactly-does-runtime-gosched-do</a></li>
</ul>
<h2 id="stm32-contiki-coroutine">stm32/ contiki/ coroutine</h2>
<p><a class="link" href="http://wiki.csie.ncku.edu.tw/embedded/Lab2"  target="_blank" rel="noopener"
    >stm32ä¸Šçš„åç¨‹å®ç°</a>
* <a class="link" href="http://blog.linux.org.tw/~jserv/archives/001848.html"  target="_blank" rel="noopener"
    >http://blog.linux.org.tw/~jserv/archives/001848.html</a></p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2023 Bg2bkk Site
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
